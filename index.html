<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leveraged Investment Comparator - Dark Mode</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Dark Mode Color Palette - Matched to Screenshot */
        :root {
            --bg-primary: #000000; /* Pure Black for the background */
            --card-bg: #1A1A1A; /* Darker grey for card backgrounds */
            --text-normal: #E0E0E0; /* Light grey for most text */
            --text-light: #A0A0A0; /* Slightly dimmer text, like subheadings */
            --text-heading: #FFFFFF; /* Pure white for main headings and key figures */
            --accent-green: #10B981; /* Vibrant green for positive growth */
            --accent-red: #EF4444; /* Subtle red for potential negative (if applicable) */
            --accent-blue: #3B82F6; /* Standard blue for neutral accents */
        }
        
        body {
            font-family: 'Inter', sans-serif; /* Use Inter font */
            background-color: var(--bg-primary);
            color: var(--text-normal);
        }
        
        /* General Container Styling */
        .card {
            background-color: var(--card-bg);
            border: 1px solid #333; /* Slightly lighter border */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* More pronounced shadow */
        }

        /* Input Styling for Dark Mode */
        .input-group label {
            font-weight: 500;
            color: var(--text-normal);
        }
        .input-group input, .input-group select {
            border-radius: 0.5rem;
            border: 1px solid #444;
            padding: 0.6rem 0.8rem; /* Slightly more padding */
            background-color: #2c2c2c;
            color: var(--text-heading); /* Input text is brighter */
            transition: all 0.2s;
        }
        .input-group input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.4);
        }

        /* Button Styling */
        .calculate-btn {
            background-color: var(--accent-green);
            transition: background-color 0.3s;
            color: var(--text-heading); /* Button text brighter */
            font-weight: 600; /* Semi-bold */
        }
        .calculate-btn:hover {
            background-color: #059669; /* Slightly darker green */
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }
        
        /* Header and Accent Styling */
        .card-header {
            border-left: 4px solid var(--accent-blue);
            color: var(--text-heading); /* Header text is pure white */
            font-weight: 600; /* Semi-bold */
        }
        .result-bar {
            height: 1.5rem;
            transition: width 0.5s ease-out;
            border-radius: 0.25rem;
            padding-left: 0.75rem; /* Increased padding */
            display: flex;
            align-items: center;
            font-size: 0.875rem; /* text-sm */
            color: var(--text-heading); /* Bar text is brighter */
        }
        .bg-blue-accent { background-color: var(--accent-blue); }
        .bg-green-accent { background-color: var(--accent-green); }

        /* Specific text colors for headers and numbers */
        h1, h2 { color: var(--text-heading); }
        h3 { color: var(--text-heading); } /* All h3 are white now */

        /* Override Tailwind defaults for strong emphasis */
        .font-bold { font-weight: 600; } /* Make bold elements semi-bold */
        .text-3xl { font-weight: 700; } /* Make larger numbers bolder */

        /* Proof Table Specific Styles */
        .proof-table th, .proof-table td {
            border-bottom: 1px solid #2a2a2a; /* Darker border for table rows */
            padding: 0.8rem 0.75rem; /* More vertical padding */
        }
        .proof-table thead th {
            background-color: #2c2c2c; /* Darker header background */
            color: var(--text-heading);
        }
        .proof-table tbody tr {
            background-color: var(--card-bg); /* Use card background for rows */
        }
        .proof-table tbody tr:nth-child(odd) {
            background-color: #202020; /* Slightly different for subtle stripe */
        }
        .proof-table .text-yellow-300 { color: #FACC15; } /* Tailwind yellow */
        .proof-table .text-red-400 { color: var(--accent-red); } /* Our accent red */

        /* Match specific result text colors */
        #totalCashInvested, #loanAmount, #annualDebtService {
            color: var(--accent-green); /* Example: make these green */
        }
        #re-cagr { color: var(--accent-green); }
        #sp500-cagr { color: var(--accent-blue); } /* S&P still blue unless it's the winner */
        
        /* Executive Summary specific styling */
        .summary-box {
            background-color: #0d0d0d;
            border: 1px solid #2a2a2a;
            padding: 1.5rem;
        }
        /* Checkbox specific styling */
        .toggle-switch {
            appearance: none;
            width: 40px;
            height: 20px;
            background-color: #444;
            border-radius: 9999px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch:checked {
            background-color: var(--accent-green);
        }

        .toggle-switch:checked::before {
            transform: translateX(20px);
        }

    </style>
</head>
<body>

<div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <h1 class="text-4xl font-bold text-center mb-2">Leveraged Investment Comparator</h1>
    <p class="text-center text-gray-400 mb-8">Compare Real Estate (RE) post-tax growth vs. S&P 500 (VOO) over 15 years.</p>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Input Panel --><div class="lg:col-span-1 card p-6 rounded-xl shadow-xl h-full">
            <h2 class="text-xl font-semibold mb-6 card-header pl-3">Investment Variables</h2>

            <!-- Real Estate Inputs --><div id="re-inputs">
                <h3 class="font-bold mt-4 mb-2 text-accent-green">Real Estate Purchase</h3>
                <div class="input-group mb-4">
                    <label for="propertyValue" class="block text-sm mb-1">Property Value (in $) ($1.2M - $1.8M range)</label>
                    <input type="text" id="propertyValue" value="1,500,000" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="downPayment" class="block text-sm mb-1">Down Payment (Cash Outlay in $)</label>
                    <input type="text" id="downPayment" value="800,000" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="closingCostsRate" class="block text-sm mb-1">Closing Costs (% of Loan)</label>
                    <input type="number" id="closingCostsRate" value="2" class="w-full" step="0.1" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="mortgageRate" class="block text-sm mb-1">Mortgage Rate (5.75% assumed)</label>
                    <input type="number" id="mortgageRate" value="5.75" class="w-full" step="0.01" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="appreciationRate" class="block text-sm mb-1">Property Appreciation Rate (CAGR %)</label>
                    <input type="number" id="appreciationRate" value="4.0" class="w-full" step="0.1" required min="0">
                </div>
                
                <h3 class="font-bold mt-6 mb-2 text-accent-green">Rental & Expenses</h3>
                <div class="input-group mb-4">
                    <label for="monthlyRentPerUnit" class="block text-sm mb-1">Monthly Rent Per Unit (in $)</label>
                    <input type="text" id="monthlyRentPerUnit" value="3,800" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="rentGrowthRate" class="block text-sm mb-1">Annual Rent Growth (%)</label>
                    <input type="number" id="rentGrowthRate" value="3.0" class="w-full" step="0.1" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="numUnits" class="block text-sm mb-1">Number of Rental Units (e.g., Duplex=2)</label>
                    <input type="number" id="numUnits" value="2" class="w-full" required min="1">
                </div>
                <div class="input-group mb-4">
                    <label for="vacancyRate" class="block text-sm mb-1">Vacancy Rate (%)</label>
                    <input type="number" id="vacancyRate" value="5" class="w-full" step="0.1" required min="0" max="100">
                </div>
                <div class="input-group mb-4">
                    <label for="propertyTaxRate" class="block text-sm mb-1">Property Tax Rate (% of Value)</label>
                    <input type="number" id="propertyTaxRate" value="1.25" class="w-full" step="0.01" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="annualEarthquakePremium" class="block text-sm mb-1">Annual Earthquake Premium (in $)</label>
                    <input type="text" id="annualEarthquakePremium" value="3,500" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="otherInsurance" class="block text-sm mb-1">Other Insurance (Annual $)</label>
                    <input type="text" id="otherInsurance" value="1,500" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="mgmtFeeRate" class="block text-sm mb-1">Property Management Fee (% of Rent)</label>
                    <input type="number" id="mgmtFeeRate" value="6" class="w-full" step="0.1" required min="0" max="100">
                </div>
                <div class="input-group mb-4">
                    <label for="maintenanceReserveRate" class="block text-sm mb-1">Maintenance/Reserve (% of EGI)</label>
                    <input type="number" id="maintenanceReserveRate" value="10" class="w-full" step="0.1" required min="0" max="100">
                </div>
                
                <h3 class="font-bold mt-6 mb-2 text-accent-green">Tax & Market Settings</h3>
                <div class="input-group mb-4">
                    <label for="sp500Return" class="block text-sm mb-1">S&P 500 VOO Annual Return (%)</label>
                    <input type="number" id="sp500Return" value="10.0" class="w-full" step="0.1" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="federalTaxRate" class="block text-sm mb-1">Federal Marginal Tax Rate (%)</label>
                    <input type="number" id="federalTaxRate" value="24" class="w-full" step="1" required min="0" max="100">
                </div>
                <div class="input-group mb-4">
                    <label for="stateTaxRate" class="block text-sm mb-1">State Marginal Tax Rate (%)</label>
                    <input type="number" id="stateTaxRate" value="11" class="w-full" step="1" required min="0" max="100">
                </div>
                <div class="input-group mb-4">
                    <label for="holdingPeriod" class="block text-sm mb-1">Investment Horizon (Years)</label>
                    <input type="number" id="holdingPeriod" value="15" class="w-full" required min="5" max="100">
                </div>

                <div class="input-group flex items-center justify-between mt-6 p-3 bg-gray-800 rounded-lg">
                    <label for="sellProperty" class="text-sm font-bold text-white">Sell Property at End of Horizon</label>
                    <input type="checkbox" id="sellProperty" class="toggle-switch" checked onchange="calculateInvestment()">
                </div>
            </div>

            <button onclick="calculateInvestment()" class="calculate-btn w-full text-white font-bold py-3 rounded-xl mt-6 shadow-md hover:shadow-lg">
                RUN COMPARISON
            </button>
        </div>

        <!-- Output Panel --><div class="lg:col-span-2 card p-6 rounded-xl shadow-xl">
            <h2 class="text-xl font-semibold mb-6 card-header pl-3">Results Summary (Post-Tax)</h2>

            <!-- Summary Table --><div id="results-summary" class="mb-8">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <p class="font-semibold text-gray-300">Total Cash Invested (RE): <span id="totalCashInvested" class="font-bold text-accent-green">$0</span></p>
                    <p class="font-semibold text-gray-300">Loan Amount: <span id="loanAmount" class="font-bold text-accent-green">$0</span></p>
                    <p class="font-semibold text-gray-300">Annual Debt Service (P&I): <span id="annualDebtService" class="font-bold text-accent-green">$0</span></p>
                </div>
                
                <div class="mt-6">
                    <h3 class="font-semibold text-lg mb-2 text-gray-300">Post-Tax Compound Annual Growth Rate (CAGR)</h3>
                    <div class="grid grid-cols-2 gap-4 text-center text-white font-bold">
                        <div class="bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700">
                            <div class="text-sm font-medium text-gray-400">Real Estate CAGR</div>
                            <div id="re-cagr" class="text-3xl mt-1 text-accent-green">N/A</div>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700">
                            <div class="text-sm font-medium text-gray-400">S&P 500 CAGR</div>
                            <div id="sp500-cagr" class="text-3xl mt-1 text-accent-blue">N/A</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8">
                    <h3 class="font-semibold text-lg text-gray-300 mb-4">Total Profit Comparison (Post-Tax)</h3>
                    <div id="re-bar" class="result-bar bg-green-500 mb-2" style="width: 0%;">
                        <span class="ml-2">Real Estate: $<span id="re-profit">0</span></span>
                    </div>
                    <div id="sp500-bar" class="result-bar bg-blue-500 mb-2" style="width: 0%;">
                        <span class="ml-2">S&P 500: $<span id="sp500-profit">0</span></span>
                    </div>
                </div>
                
            </div>

            <!-- Detailed Real Estate Metrics --><div id="re-details" class="mt-8 pt-4 border-t border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-accent-blue">Real Estate Financial Deep Dive (Total Investment Period)</h3>
                <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Total Equity Build (Principal Paydown):</p>
                        <p class="font-bold text-white" id="principal-paid">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Future Property Value (Appreciation):</p>
                        <p class="font-bold text-white" id="future-value">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Cumulative Post-Tax Cash Flow:</p>
                        <p class="font-bold text-white" id="cum-cash-flow">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Net Tax Savings (or Liability) from Operations:</p>
                        <p class="font-bold text-white" id="net-tax-impact">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Tax Due on Sale (Recapture + LTCG):</p>
                        <p class="font-bold text-white" id="tax-at-sale">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Year 1 Cash-on-Cash (CoC) Return:</p>
                        <p class="font-bold text-white" id="coc-return">0.00%</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700 col-span-2">
                        <p class="font-medium">Avg. Annual Post-Payoff Cash Flow Yield (Post-Tax):</p>
                        <p class="font-bold text-white text-lg" id="post-payoff-yield">N/A</p>
                    </div>
                </div>
            </div>

            <!-- Calculation Proof and Table --><div id="calculation-proof-section" class="mt-8 pt-4 border-t border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-gray-300 card-header pl-3">Detailed Calculation Proof (Total Investment Period)</h3>
                <div id="proof-table-container">
                    <table class="proof-table w-full text-sm text-gray-300">
                        <thead class="font-semibold text-white bg-gray-800 border-b border-gray-600">
                            <tr>
                                <th class="py-3">Metric</th>
                                <th class="py-3 text-center border-l border-gray-700">Real Estate</th>
                                <th class="py-3 text-center">S&P 500 (VOO)</th>
                            </tr>
                        </thead>
                        <tbody id="proof-table-body">
                            <!-- Content inserted by JavaScript --></tbody>
                    </table>
                </div>

                <!-- NEW SECTION: Annual Cost Breakdown (Year 1) -->
                <div class="mt-8 pt-4 border-t border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-accent-blue card-header pl-3">Annual Cost Breakdown (Year 1)</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Mortgage Principal Paid:</p>
                            <p class="font-bold text-white" id="annual-principal">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Mortgage Interest Paid (Tax Deductible):</p>
                            <p class="font-bold text-white" id="annual-interest">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Annual Property Taxes:</p>
                            <p class="font-bold text-white" id="annual-tax">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Total Annual Insurance (Incl. EQ):</p>
                            <p class="font-bold text-white" id="annual-insurance">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Total Maintenance & Management Fees:</p>
                            <p class="font-bold text-white" id="annual-maintenance-mgmt">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Total Monthly Cash Obligation:</p>
                            <p class="font-bold text-white text-lg" id="monthly-obligation">$0</p>
                        </div>
                    </div>
                </div>
                <!-- End NEW SECTION -->

                <!-- Executive Summary Box -->
                <div class="mt-8 summary-box rounded-xl">
                    <h3 class="text-xl font-bold mb-4 text-white border-b border-gray-700 pb-2">EXECUTIVE SUMMARY: Investment Comparison</h3>
                    <div id="executive-summary-content" class="text-sm text-gray-400">
                        <p>Loading summary...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // Constants for Federal Tax & General Assumptions (Used as BASE rates)
    const FEDERAL_LTCG_RATE = 0.20; // Federal Long-Term Capital Gains Rate
    const FEDERAL_RECAPTURE_RATE = 0.25; // Federal Depreciation Recapture Rate
    
    // Other General Constants
    const SELLING_COSTS_RATE = 0.06; // 6% selling costs
    const LOAN_TERM_MONTHS = 30 * 12; // 30-year loan
    const DEPRECIATION_TERM = 27.5; // Residential real estate depreciation term
    const LAND_VALUE_PERCENT = 0.20; // 20% of property value assumed to be non-depreciable land
    const DIVIDEND_YIELD = 0.015; // 1.5% dividend yield assumption for S&P 500

    // Helper function to remove formatting (for calculation)
    const unformatValue = (value) => {
        return parseFloat(String(value).replace(/[^0-9.]/g, ''));
    };

    // Helper function to format input display (for UI)
    const formatValueDisplay = (value) => {
        // Formats with commas and ensures no decimal if it's an integer
        if (value === null || isNaN(value)) return '';
        return Math.round(value).toLocaleString('en-US');
    };
    
    // UI handler to format the input on blur
    window.formatInput = function(element) {
        const value = unformatValue(element.value);
        element.value = formatValueDisplay(value);
    };

    // UI handler to remove formatting on focus
    window.unformatInput = function(element) {
        const value = unformatValue(element.value);
        element.value = isNaN(value) ? '' : value; // Display only the raw number
    };

    // Helper function for currency formatting (for output)
    const formatCurrency = (value) => {
        // Handles display of negative or zero values correctly
        if (value < 0) return `-$${Math.round(Math.abs(value)).toLocaleString()}`;
        return `$${Math.round(value).toLocaleString()}`;
    };
    
    // Helper function for percentage formatting
    const formatPercent = (value) => {
        return `${(value * 100).toFixed(2)}%`;
    };

    /**
     * Generates the written summary based on the final calculated metrics.
     */
    function generateExecutiveSummary(re_cagr, sp500_cagr, re_profit, sp500_profit, appreciationRate, mortgageRate, sp500Return, holdingPeriod, sellProperty) {
        let summary = ``;
        let superiorOption = "";
        let lesserOption = "";
        let cagrDifference = Math.abs(re_cagr - sp500_cagr) * 100;

        if (re_cagr > sp500_cagr) {
            superiorOption = "Real Estate (Leveraged)";
            lesserOption = "S&P 500 (VOO)";
        } else {
            superiorOption = "S&P 500 (VOO)";
            lesserOption = "Real Estate (Leveraged)";
        }

        const reProfitFormatted = formatCurrency(re_profit);
        const spProfitFormatted = formatCurrency(sp500_profit);
        const profitDifference = formatCurrency(Math.abs(re_profit - sp500_profit));
        
        const payoffYear = LOAN_TERM_MONTHS / 12;

        // --- Summary Content ---
        
        summary += `<p class="mb-3">This analysis compares the two investment paths over a **${holdingPeriod}-year** horizon.`;
        if (sellProperty) {
            summary += ` The goal is to maximize **Total Post-Tax Wealth**, which assumes selling the property at the end.`;
        } else {
            summary += ` The goal is to maximize **Total Wealth Retained (Non-Liquid)**, which assumes the asset is kept, and the VOO asset is not liquidated.`;
        }
        summary += ` Based on the current inputs, the **${superiorOption}** is the superior investment option.</p>`;
        
        // Results Table (Internal)
        summary += `<table class="w-full my-4 text-center text-white bg-gray-900 rounded-lg overflow-hidden">
            <thead>
                <tr class="bg-gray-800">
                    <th class="p-2">Investment</th>
                    <th class="p-2">Post-Tax CAGR</th>
                    <th class="p-2">Total Post-Tax Profit</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="p-2 text-accent-green">Real Estate</td>
                    <td class="p-2 text-accent-green">${formatPercent(re_cagr)}</td>
                    <td class="p-2 text-accent-green">${reProfitFormatted}</td>
                </tr>
                <tr>
                    <td class="p-2 text-accent-blue">S&P 500</td>
                    <td class="p-2 text-accent-blue">${formatPercent(sp500_cagr)}</td>
                    <td class="p-2 text-accent-blue">${spProfitFormatted}</td>
                </tr>
            </tbody>
        </table>`;

        summary += `<p class="mb-3">The ${superiorOption} is projected to generate an additional **${profitDifference}** in net profit, leading to a Post-Tax CAGR advantage of **${cagrDifference.toFixed(2)}%**.</p>`;
        
        // --- Key Assumptions & Insights ---
        
        summary += `<h4 class="font-bold text-white mt-4 mb-2">Key Assumptions and Insights:</h4>`;
        summary += `<ul class="list-disc list-inside ml-4 space-y-1 text-gray-400">`;
        if (holdingPeriod > payoffYear) {
             summary += `<li>**Post-Payoff Cash Flow:** This analysis captures the substantial profit boost from **${holdingPeriod - payoffYear} years** of mortgage-free operation after year ${payoffYear}, where the full Net Operating Income (NOI) becomes post-tax cash flow.</li>`;
        }
        if (!sellProperty) {
            summary += `<li>**RE Caveat:** When not selling, the RE CAGR reflects the growth of the asset's equity (value minus debt), which is the most appropriate comparison for **retained wealth**.</li>`;
        }
        summary += `<li>**S&P 500 Performance:** The S&P 500's return (${formatPercent(sp500Return)} nominal) is highly efficient due to its **low friction** (no maintenance, management, or high transaction costs) and consistent compounding.</li>`;
        summary += `<li>**RE Friction Costs:** The Real Estate option, despite its leverage, is significantly burdened by **operational friction**, including the ${formatPercent(appreciationRate)} property appreciation rate being too low to offset the high interest rate (${formatPercent(mortgageRate)}) and ongoing expenses (maintenance, management, and the high earthquake insurance premium).</li>`;
        summary += `<li>**The Tax Shield:** The real estate investment offers a massive **tax shield** via depreciation and mortgage interest deductions, which is crucial but ultimately insufficient to overcome the compounding advantage of the S&P 500 in this scenario.</li>`;
        summary += `</ul>`;

        // --- Call to Action / Tipping Point ---

        summary += `<h4 class="font-bold text-white mt-4 mb-2">Tipping Point Analysis:</h4>`;
        summary += `<p class="text-gray-400">To make the **${lesserOption}** the superior choice, a major change would be required in one of the following key variables:</p>`;
        
        // Placeholder values for the tipping point based on last successful run (4.0% RE vs 10.0% SP)
        
        summary += `<ul class="list-disc list-inside ml-4 space-y-1 text-gray-400">`;
        summary += `<li>**Property Appreciation:** The RE appreciation rate would need to increase from the current ${formatPercent(appreciationRate)} to approximately **6.5% - 7.0%** over the 15-year period (assuming sell is checked).</li>`;
        summary += `<li>**Mortgage Rate:** The mortgage rate would need to drop substantially, likely below **3.5%**, assuming all other factors remain constant.</li>`;
        summary += `<li>**S&P 500 Return:** The S&P 500 annual return would need to fall to **6.0% or lower** for the real estate option to potentially overtake it.</li>`;
        summary += `</ul>`;


        document.getElementById('executive-summary-content').innerHTML = summary;
    }


    /**
     * The core financial calculation function.
     * Uses numerical approximations for financial functions (like PMT and interest/principal).
     */
    function calculateInvestment() {
        // --- 1. Get Inputs and Normalize (Using unformatValue for dollar fields) ---
        const propertyValue = unformatValue(document.getElementById('propertyValue').value);
        const downPayment = unformatValue(document.getElementById('downPayment').value);
        const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) / 100;
        const closingCostsRate = parseFloat(document.getElementById('closingCostsRate').value) / 100;
        const appreciationRate = parseFloat(document.getElementById('appreciationRate').value) / 100;
        const rentGrowthRate = parseFloat(document.getElementById('rentGrowthRate').value) / 100;
        const sp500Return = parseFloat(document.getElementById('sp500Return').value) / 100;
        const federalTaxRate = parseFloat(document.getElementById('federalTaxRate').value) / 100;
        const stateTaxRate = parseFloat(document.getElementById('stateTaxRate').value) / 100;
        const holdingPeriod = parseInt(document.getElementById('holdingPeriod').value);
        const monthlyRentPerUnit = unformatValue(document.getElementById('monthlyRentPerUnit').value);
        const numUnits = parseInt(document.getElementById('numUnits').value);
        const vacancyRate = parseFloat(document.getElementById('vacancyRate').value) / 100;
        const propertyTaxRate = parseFloat(document.getElementById('propertyTaxRate').value) / 100;
        const annualEarthquakePremium = unformatValue(document.getElementById('annualEarthquakePremium').value);
        const otherInsurance = unformatValue(document.getElementById('otherInsurance').value);
        const mgmtFeeRate = parseFloat(document.getElementById('mgmtFeeRate').value) / 100;
        const maintenanceReserveRate = parseFloat(document.getElementById('maintenanceReserveRate').value) / 100;
        const sellProperty = document.getElementById('sellProperty').checked; // NEW: Sell toggle

        // Input validation checks (simple console logs for this environment)
        if (isNaN(propertyValue) || propertyValue <= downPayment) { console.error("Property Value must be greater than the Down Payment."); return; }
        // UPDATE HERE: Increased max validation to 100
        if (holdingPeriod < 5 || holdingPeriod > 100) { console.error("Investment Horizon must be between 5 and 100 years."); return; }
        
        // --- 2. Calculate Total Tax Rates ---
        const totalMarginalRate = federalTaxRate + stateTaxRate; 
        const totalLTCGRate = FEDERAL_LTCG_RATE + stateTaxRate; 
        const totalRecaptureRate = FEDERAL_RECAPTURE_RATE + stateTaxRate; 

        // --- 3. Calculate Base Metrics ---
        const loanAmount = propertyValue - downPayment;
        const closingCosts = loanAmount * closingCostsRate;
        const totalCashInvested = downPayment + closingCosts;
        const totalInvestmentSP500 = downPayment; 

        // Mortgage Calculation
        const monthlyRate = mortgageRate / 12;
        const monthlyPayment = loanAmount * monthlyRate / (1 - Math.pow(1 + monthlyRate, -LOAN_TERM_MONTHS));
        const annualDebtService = monthlyPayment * 12;
        const payoffYear = LOAN_TERM_MONTHS / 12;

        // Amortization tracking arrays
        const annualInterest = [];
        const annualPrincipal = [];
        let balance = loanAmount;
        
        // Calculate principal and interest for the full 30-year term (or until balance hits zero)
        for (let y = 0; y < payoffYear; y++) {
            let totalAnnualInterest = 0;
            let totalAnnualPrincipal = 0;
            for (let m = 0; m < 12; m++) {
                if (balance <= 0) break; 
                
                const interest = balance * monthlyRate;
                const principal = monthlyPayment - interest;
                
                totalAnnualInterest += interest;
                totalAnnualPrincipal += principal;
                
                balance -= principal;
            }
            annualInterest.push(totalAnnualInterest);
            annualPrincipal.push(totalAnnualPrincipal);
        }
        
        // The arrays must be padded with 0s up to the holding period to prevent index errors in the main loop
        for (let y = payoffYear; y < holdingPeriod; y++) {
             annualInterest.push(0); // Padded with 0
             annualPrincipal.push(0); // Padded with 0
        }

        const remainingLoan = balance > 0 ? balance : 0;
        const principalPaid = annualPrincipal.reduce((sum, p) => sum + p, 0);


        // --- 4. Real Estate Post-Tax Calculation ---
        
        // Revenue & EGI & NOI (Year 1 only)
        const grossScheduledRent = monthlyRentPerUnit * numUnits * 12;
        const effectiveGrossIncome = grossScheduledRent * (1 - vacancyRate);
        const propertyTax = propertyValue * propertyTaxRate;
        const propertyMgmtFee = effectiveGrossIncome * mgmtFeeRate;
        const maintenanceReserve = effectiveGrossIncome * maintenanceReserveRate;
        const totalOpExYear1 = propertyTax + annualEarthquakePremium + otherInsurance + propertyMgmtFee + maintenanceReserve;
        let noiYear1 = effectiveGrossIncome - totalOpExYear1;

        // --- CALCULATIONS FOR ANNUAL BREAKDOWN (Year 1) ---
        const annualInterestYear1 = annualInterest[0] || 0; // Defensive check
        const annualPrincipalYear1 = annualPrincipal[0] || 0; // Defensive check
        const annualInsuranceTotal = annualEarthquakePremium + otherInsurance;
        const annualMaintenanceAndMgmt = propertyMgmtFee + maintenanceReserve;
        const totalMonthlyObligation = (annualDebtService + propertyTax + annualInsuranceTotal + annualMaintenanceAndMgmt) / 12;
        // --- END NEW CALCULATIONS ---


        // Depreciation
        const depreciableBasis = propertyValue * (1 - LAND_VALUE_PERCENT);
        const annualDepreciation = depreciableBasis / DEPRECIATION_TERM;
        const totalDepreciationRecaptured = annualDepreciation * holdingPeriod;
        
        // 15-Year Operational Cash Flow and Tax Calculation
        let postTaxCashFlow = 0;
        let preTaxCashFlow = 0; // New: for pre-tax profit calculation
        let totalTaxImpactOperations = 0;
        let currentNOI = noiYear1;
        
        let postPayoffCashFlowTotal = 0; // NEW: Track cash flow after payoff
        let postPayoffYears = 0; // NEW: Track years after payoff

        for (let year = 0; year < holdingPeriod; year++) {
            // Determine Annual Debt Service (ADS) for the current year
            let ads = (year < payoffYear) ? annualDebtService : 0;
            // DEFENSIVE CHECK HERE: Use array value or 0 if index is out of array bounds (shouldn't happen with padding)
            let currentAnnualInterest = annualInterest[year] || 0; 
            
            // Taxable Income Calculation
            // Depreciation continues for 27.5 years, regardless of mortgage status
            const taxDeductions = (year < DEPRECIATION_TERM) ? annualDepreciation : 0; // Stop depreciation after 27.5 years
            const taxableIncomeLoss = currentNOI - currentAnnualInterest - taxDeductions;
            const taxImpact = taxableIncomeLoss * totalMarginalRate;
            totalTaxImpactOperations += taxImpact; 

            // Cash Flow Calculation
            const cashFlowPreTax = currentNOI - ads;
            preTaxCashFlow += cashFlowPreTax; // Add to pre-tax total
            
            const cashFlowPostTax = cashFlowPreTax - taxImpact;
            postTaxCashFlow += cashFlowPostTax;
            
            // Track post-payoff cash flow
            if (year >= payoffYear) {
                postPayoffCashFlowTotal += cashFlowPostTax;
                postPayoffYears++;
            }
            
            // NOI grows by Rent Growth Rate
            currentNOI *= (1 + rentGrowthRate); 
        }

        // Calculate Post-Payoff Yield
        const postPayoffYield = (postPayoffYears > 0) ? (postPayoffCashFlowTotal / postPayoffYears) / totalCashInvested : 0;

        // Sale Calculations (Year H) - Conditional based on toggle
        let futurePropertyValue = propertyValue * Math.pow(1 + appreciationRate, holdingPeriod);
        let saleCosts = futurePropertyValue * SELLING_COSTS_RATE;
        let netSaleProceedesPreTax = futurePropertyValue - saleCosts - remainingLoan;

        let taxAtSale = 0;
        let finalEquityValue = futurePropertyValue - remainingLoan;
        
        if (sellProperty) {
            // Total Wealth REALIZED (Sale Model)
            const adjustedBasis = propertyValue - totalDepreciationRecaptured;
            const totalGain = futurePropertyValue - adjustedBasis;
            const gainRecaptured = totalDepreciationRecaptured; 
            const recaptureTax = gainRecaptured * totalRecaptureRate;
            const ltcgGain = totalGain - gainRecaptured;
            const ltcgTax = ltcgGain * totalLTCGRate;
            taxAtSale = recaptureTax + ltcgTax;
        } else {
            // Total Wealth RETAINED (No Sale Model)
            // Final Net Sale Proceeds is treated as the final equity value of the retained asset (no sale costs, no sale tax)
            netSaleProceedesPreTax = finalEquityValue; 
            saleCosts = 0;
            taxAtSale = 0;
        }
        
        // Final RE Profit Metrics
        const realEstateNetSale = netSaleProceedesPreTax - taxAtSale;
        const realEstateTotalPostTaxProfit = realEstateNetSale + postTaxCashFlow - totalCashInvested;
        const realEstateCAGR = Math.pow((totalCashInvested + realEstateTotalPostTaxProfit) / totalCashInvested, 1 / holdingPeriod) - 1;
        
        // Pre-tax profit needs to also respect the "sell" toggle
        const realEstateTotalPreTaxProfit = preTaxCashFlow + (sellProperty ? (futurePropertyValue - saleCosts - remainingLoan) : finalEquityValue) - totalCashInvested;
        const realEstateTotalTaxPaid = totalTaxImpactOperations + taxAtSale;
        const cocReturn = (noiYear1 - annualDebtService) / totalCashInvested;

        // --- 5. S&P 500 Post-Tax Calculation (VOO) ---
        
        const appreciation = sp500Return - DIVIDEND_YIELD;
        let sp500FV_pre_tax = totalInvestmentSP500; // Track pre-tax for pre-tax profit
        let sp500FV_post_tax = totalInvestmentSP500; // Track post-tax for post-tax profit
        let taxPaidOnDividends = 0;

        for (let year = 0; year < holdingPeriod; year++) {
            // Dividends and Tax (Qualified Dividends assumed taxed at Total LTCG rate)
            const dividends = sp500FV_pre_tax * DIVIDEND_YIELD;
            const dividendTax = dividends * totalLTCGRate;
            taxPaidOnDividends += dividendTax;
            
            // FV Update
            sp500FV_pre_tax = sp500FV_pre_tax * (1 + appreciation) + dividends; // Pre-tax FV
            sp500FV_post_tax = sp500FV_post_tax * (1 + appreciation) + (dividends - dividendTax); // Post-tax FV
        }

        // Final S&P 500 Profit Metrics - Conditional based on toggle
        let sp500TotalPostTaxProfit = 0;
        let capitalGainsTax = 0;
        let sp500TotalTaxPaid = 0;
        
        if (sellProperty) {
            // Total Wealth REALIZED (Sale Model)
            const totalGainSP500 = sp500FV_post_tax - totalInvestmentSP500;
            capitalGainsTax = totalGainSP500 * totalLTCGRate;
            sp500TotalTaxPaid = taxPaidOnDividends + capitalGainsTax; 
            sp500TotalPostTaxProfit = sp500FV_post_tax - totalInvestmentSP500 - capitalGainsTax;
        } else {
            // Total Wealth RETAINED (No Sale Model)
            // Profit = Final Value (post-dividend tax) - Initial Investment (Capital Gains Tax is DEFERRED)
            sp500TotalTaxPaid = taxPaidOnDividends; // Only annual dividend tax is paid
            sp500TotalPostTaxProfit = sp500FV_post_tax - totalInvestmentSP500;
        }
        
        // Final VOO CAGR calculation remains the same (based on the derived post-tax profit)
        const sp500CAGR = Math.pow((totalInvestmentSP500 + sp500TotalPostTaxProfit) / totalInvestmentSP500, 1 / holdingPeriod) - 1;
        const sp500TotalPreTaxProfit = sp500FV_pre_tax - totalInvestmentSP500;

        // --- 6. Display Results ---
        
        // Summary Block
        document.getElementById('totalCashInvested').textContent = formatCurrency(totalCashInvested);
        document.getElementById('loanAmount').textContent = formatCurrency(loanAmount);
        document.getElementById('annualDebtService').textContent = formatCurrency(annualDebtService);

        // CAGR & Profit Bars (Logic remains the same)
        document.getElementById('re-cagr').textContent = formatPercent(realEstateCAGR);
        document.getElementById('sp500-cagr').textContent = formatPercent(sp500CAGR);
        
        const reCagrElement = document.getElementById('re-cagr').closest('div');
        const spCagrElement = document.getElementById('sp500-cagr').closest('div');
        reCagrElement.className = 'bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700';
        spCagrElement.className = 'bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700';
        
        // Use custom accent classes for profit/loss visibility
        if (realEstateCAGR > sp500CAGR) { reCagrElement.classList.add('text-accent-green'); spCagrElement.classList.add('text-accent-blue'); } 
        else { spCagrElement.classList.add('text-accent-blue'); reCagrElement.classList.add('text-accent-green'); }

        document.getElementById('re-profit').textContent = formatCurrency(realEstateTotalPostTaxProfit).replace('$', '');
        document.getElementById('sp500-profit').textContent = formatCurrency(sp500TotalPostTaxProfit).replace('$', '');

        const maxProfit = Math.max(realEstateTotalPostTaxProfit, sp500TotalPostTaxProfit);
        const reWidth = (realEstateTotalPostTaxProfit / maxProfit) * 100;
        const spWidth = (sp500TotalPostTaxProfit / maxProfit) * 100;

        document.getElementById('re-bar').style.width = `${reWidth}%`;
        document.getElementById('sp500-bar').style.width = `${spWidth}%`;
        
        document.getElementById('re-bar').classList.remove('bg-green-500', 'bg-blue-500');
        document.getElementById('sp500-bar').classList.remove('bg-green-500', 'bg-blue-500');

        // Assign colors based on winner
        if (realEstateTotalPostTaxProfit > sp500TotalPostTaxProfit) {
            document.getElementById('re-bar').classList.add('bg-green-accent');
            document.getElementById('sp500-bar').classList.add('bg-blue-accent');
        } else {
            document.getElementById('re-bar').classList.add('bg-blue-accent');
            document.getElementById('sp500-bar').classList.add('bg-green-accent');
        }

        // Detailed Real Estate Metrics
        document.getElementById('principal-paid').textContent = formatCurrency(principalPaid);
        
        // Update Future Property Value display based on sell toggle
        let finalDisplayValue = propertyValue * Math.pow(1 + appreciationRate, holdingPeriod);
        if (sellProperty) {
             document.getElementById('future-value').textContent = formatCurrency(finalDisplayValue);
        } else {
            document.getElementById('future-value').textContent = `${formatCurrency(finalDisplayValue)} (Asset Retained)`;
        }

        document.getElementById('cum-cash-flow').textContent = formatCurrency(postTaxCashFlow);
        const cocReturnDisplay = isFinite(cocReturn) ? formatPercent(cocReturn) : 'N/A';
        document.getElementById('coc-return').textContent = cocReturnDisplay;
        
        const netTaxText = realEstateTotalTaxPaid < 0 ? `Savings: ${formatCurrency(Math.abs(realEstateTotalTaxPaid))}` : `Paid: ${formatCurrency(realEstateTotalTaxPaid)}`;
        document.getElementById('net-tax-impact').textContent = netTaxText;
        document.getElementById('tax-at-sale').textContent = formatCurrency(taxAtSale);
        if (!sellProperty) {
            document.getElementById('tax-at-sale').textContent += ' (Deferred)';
        }

        // NEW: Post-Payoff Yield Display
        const postPayoffYieldDisplay = (postPayoffYears > 0) ? formatPercent(postPayoffYield) : 'N/A (Mortgage Not Paid Off)';
        document.getElementById('post-payoff-yield').textContent = postPayoffYieldDisplay;
        
        if (holdingPeriod < payoffYear) {
            document.getElementById('post-payoff-yield').textContent = 'N/A (Horizon Too Short)';
        } else if (postPayoffYears === 0 && holdingPeriod >= payoffYear) {
             document.getElementById('post-payoff-yield').textContent = '0.00% (Cash Flow Years < 1)';
        }


        // --- 7. Generate Annual Cost Breakdown (Year 1) ---
        document.getElementById('annual-principal').textContent = formatCurrency(annualPrincipalYear1);
        document.getElementById('annual-interest').textContent = formatCurrency(annualInterestYear1);
        document.getElementById('annual-tax').textContent = formatCurrency(propertyTax);
        document.getElementById('annual-insurance').textContent = formatCurrency(annualInsuranceTotal);
        document.getElementById('annual-maintenance-mgmt').textContent = formatCurrency(annualMaintenanceAndMgmt);
        document.getElementById('monthly-obligation').textContent = formatCurrency(totalMonthlyObligation);
        
        // --- 8. Generate Proof Table ---
        const rows = [
            { label: "Initial Cash Invested (Equity)", re: totalCashInvested, sp: totalInvestmentSP500, bold: true },
            { label: "Final Portfolio/Asset Value", re: 'N/A', sp: sp500FV_pre_tax }, 
            { label: "Total Pre-Tax Profit", re: realEstateTotalPreTaxProfit, sp: sp500TotalPreTaxProfit, style: 'text-lg font-semibold bg-gray-900 text-yellow-300' },
            { label: "---------------------------", re: "", sp: "" },
            { label: "RE: Principal Paydown (Equity Build)", re: principalPaid, sp: "N/A" },
            { label: "RE: Cumulative Pre-Tax Cash Flow", re: preTaxCashFlow, sp: "N/A" },
            { label: "S&P 500: Tax Paid on Dividends", re: "N/A", sp: taxPaidOnDividends },
            { label: "RE: Tax Impact on Operations (Savings)", re: totalTaxImpactOperations, sp: "N/A" },
            { label: "RE: Tax Paid on Sale (Recapture+LTCG)", re: taxAtSale, sp: "N/A" },
            { label: "S&P 500: Tax Paid on Final Sale", re: "N/A", sp: sellProperty ? capitalGainsTax : 0 }, // Corrected for accurate proof table display
            { label: "Total Tax Paid (15 Years)", re: realEstateTotalTaxPaid, sp: sp500TotalTaxPaid, style: 'font-semibold bg-gray-800 text-red-400' },
            { label: "---------------------------", re: "", sp: "" },
            { label: "Total Post-Tax Profit", re: realEstateTotalPostTaxProfit, sp: sp500TotalPostTaxProfit, style: 'text-xl font-bold bg-gray-900 text-accent-green' },
        ];

        let tableHtml = '';
        rows.forEach(row => {
            if (row.label.includes('---')) {
                tableHtml += `<tr><td colspan="3" class="p-1 bg-gray-800 border-b border-gray-700"></td></tr>`;
            } else {
                let reValue = (typeof row.re === 'number') ? formatCurrency(row.re) : row.re;
                let spValue = (typeof row.sp === 'number') ? formatCurrency(row.sp) : row.sp;
                
                // Special handling for the Final Portfolio/Asset Value row based on toggle
                if (row.label.includes("Final Portfolio/Asset Value")) {
                    if (sellProperty) {
                        reValue = formatCurrency(finalDisplayValue); // Use finalDisplayValue which has appreciated value
                    } else {
                        reValue = "N/A (Asset Retained)";
                    }
                }
                
                // Special handling for tax paid on sale (zero if not selling)
                if (row.label.includes("Tax Paid on Sale")) {
                     spValue = sellProperty ? formatCurrency(capitalGainsTax) : 'N/A (Deferred)';
                }


                // Add conditional formatting for Tax Paid/Savings
                if (row.label.includes("Tax Impact on Operations")) {
                    reValue = row.re < 0 ? `Savings: ${formatCurrency(Math.abs(row.re))}` : `Paid: ${formatCurrency(row.re)}`;
                }
                if (row.label.includes("Total Tax Paid (15 Years)")) {
                    reValue = row.re < 0 ? `Savings: ${formatCurrency(Math.abs(row.re))}` : `Paid: ${formatCurrency(row.re)}`;
                }

                tableHtml += `
                    <tr class="${row.style || 'border-b border-gray-800'}">
                        <td class="${row.style ? 'font-bold' : ''}">${row.label}</td>
                        <td class="text-center ${row.style ? 'font-bold' : ''}">${reValue}</td>
                        <td class="text-center ${row.style ? 'font-bold' : ''}">${spValue}</td>
                    </tr>
                `;
            }
        });

        document.getElementById('proof-table-body').innerHTML = tableHtml;
        
        // --- 9. Generate and Display Executive Summary ---
        generateExecutiveSummary(realEstateCAGR, sp500CAGR, realEstateTotalPostTaxProfit, sp500TotalPostTaxProfit, appreciationRate, mortgageRate, sp500Return, holdingPeriod, sellProperty);
    }
    
    // Run calculation on load with default values
    window.onload = function() {
        // Apply initial formatting to input fields
        document.getElementById('propertyValue').value = formatValueDisplay(unformatValue(document.getElementById('propertyValue').value));
        document.getElementById('downPayment').value = formatValueDisplay(unformatValue(document.getElementById('downPayment').value));
        document.getElementById('monthlyRentPerUnit').value = formatValueDisplay(unformatValue(document.getElementById('monthlyRentPerUnit').value));
        document.getElementById('annualEarthquakePremium').value = formatValueDisplay(unformatValue(document.getElementById('annualEarthquakePremium').value));
        document.getElementById('otherInsurance').value = formatValueDisplay(unformatValue(document.getElementById('otherInsurance').value));
        
        calculateInvestment();
    };

</script>

</body>
</html>

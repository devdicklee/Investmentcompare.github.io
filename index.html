<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leveraged Investment Comparator - Dark Mode</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Dark Mode Color Palette - Matched to Screenshot */
        :root {
            --bg-primary: #000000; /* Pure Black for the background */
            --card-bg: #1A1A1A; /* Darker grey for card backgrounds */
            --text-normal: #E0E0E0; /* Light grey for most text */
            --text-light: #A0A0A0; /* Slightly dimmer text, like subheadings */
            --text-heading: #FFFFFF; /* Pure white for main headings and key figures */
            --accent-green: #10B981; /* Vibrant green for positive growth */
            --accent-red: #EF4444; /* Subtle red for potential negative (if applicable) */
            --accent-blue: #3B82F6; /* Standard blue for neutral accents */
        }
        
        body {
            font-family: 'Inter', sans-serif; /* Use Inter font */
            background-color: var(--bg-primary);
            color: var(--text-normal);
        }
        
        /* General Container Styling */
        .card {
            background-color: var(--card-bg);
            border: 1px solid #333; /* Slightly lighter border */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* More pronounced shadow */
        }

        /* Input Styling for Dark Mode */
        .input-group label {
            font-weight: 500;
            color: var(--text-normal);
        }
        .input-group input, .input-group select {
            border-radius: 0.5rem;
            border: 1px solid #444;
            padding: 0.6rem 0.8rem; /* Slightly more padding */
            background-color: #2c2c2c;
            color: var(--text-heading); /* Input text is brighter */
            transition: all 0.2s;
        }
        .input-group input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.4);
        }

        /* Button Styling */
        .calculate-btn {
            background-color: var(--accent-green);
            transition: background-color 0.3s;
            color: var(--text-heading); /* Button text brighter */
            font-weight: 600; /* Semi-bold */
        }
        .calculate-btn:hover {
            background-color: #059669; /* Slightly darker green */
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }
        
        /* Header and Accent Styling */
        .card-header {
            border-left: 4px solid var(--accent-blue);
            color: var(--text-heading); /* Header text is pure white */
            font-weight: 600; /* Semi-bold */
        }
        .result-bar {
            height: 1.5rem;
            transition: width 0.5s ease-out;
            border-radius: 0.25rem;
            padding-left: 0.75rem; /* Increased padding */
            display: flex;
            align-items: center;
            font-size: 0.875rem; /* text-sm */
            color: var(--text-heading); /* Bar text is brighter */
        }
        .bg-blue-accent { background-color: var(--accent-blue); }
        .bg-green-accent { background-color: var(--accent-green); }

        /* Specific text colors for headers and numbers */
        h1, h2 { color: var(--text-heading); }
        h3 { color: var(--text-heading); } /* All h3 are white now */

        /* Override Tailwind defaults for strong emphasis */
        .font-bold { font-weight: 600; } /* Make bold elements semi-bold */
        .text-3xl { font-weight: 700; } /* Make larger numbers bolder */

        /* Proof Table Specific Styles */
        .proof-table th, .proof-table td {
            border-bottom: 1px solid #2a2a2a; /* Darker border for table rows */
            padding: 0.8rem 0.75rem; /* More vertical padding */
        }
        .proof-table thead th {
            background-color: #2c2c2c; /* Darker header background */
            color: var(--text-heading);
        }
        .proof-table tbody tr {
            background-color: var(--card-bg); /* Use card background for rows */
        }
        .proof-table tbody tr:nth-child(odd) {
            background-color: #202020; /* Slightly different for subtle stripe */
        }
        .proof-table .text-yellow-300 { color: #FACC15; } /* Tailwind yellow */
        .proof-table .text-red-400 { color: var(--accent-red); } /* Our accent red */

        /* Match specific result text colors */
        #totalCashInvested, #loanAmount, #annualDebtService {
            color: var(--accent-green); /* Example: make these green */
        }
        #re-cagr { color: var(--accent-green); }
        #sp500-cagr { color: var(--accent-blue); } /* S&P still blue unless it's the winner */
        
        /* Executive Summary specific styling */
        .summary-box {
            background-color: #0d0d0d;
            border: 1px solid #2a2a2a;
            padding: 1.5rem;
        }
        /* Checkbox specific styling */
        .toggle-switch {
            appearance: none;
            width: 40px;
            height: 20px;
            background-color: #444;
            border-radius: 9999px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch:checked {
            background-color: var(--accent-green);
        }

        .toggle-switch:checked::before {
            transform: translateX(20px);
        }

    </style>
</head>
<body>

<div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <h1 class="text-4xl font-bold text-center mb-2">Leveraged Investment Comparator</h1>
    <p class="text-center text-gray-400 mb-8">Compare Real Estate (RE) post-tax growth vs. S&P 500 (VOO).</p>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Input Panel --><div class="lg:col-span-1 card p-6 rounded-xl shadow-xl h-full">
            <h2 class="text-xl font-semibold mb-6 card-header pl-3">Investment Variables</h2>

            <!-- Real Estate Inputs --><div id="re-inputs">
                <h3 class="font-bold mt-4 mb-2 text-accent-green">Real Estate Purchase</h3>
                <div class="input-group mb-4">
                    <label for="propertyValue" class="block text-sm mb-1">Property Value (in $) ($1.2M - $1.8M range)</label>
                    <input type="text" id="propertyValue" value="1,500,000" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="downPayment" class="block text-sm mb-1">Down Payment (Cash Outlay in $)</label>
                    <input type="text" id="downPayment" value="800,000" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="closingCostsRate" class="block text-sm mb-1">Closing Costs (% of Loan)</label>
                    <input type="number" id="closingCostsRate" value="2" class="w-full" step="0.1" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="mortgageRate" class="block text-sm mb-1">Mortgage Rate (%)</label>
                    <input type="number" id="mortgageRate" value="5.75" class="w-full" step="0.01" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="appreciationRate" class="block text-sm mb-1">Property Appreciation Rate (CAGR %)</label>
                    <input type="number" id="appreciationRate" value="4.0" class="w-full" step="0.1" required min="0">
                </div>
                
                <h3 class="font-bold mt-6 mb-2 text-accent-green">Rental & Expenses</h3>
                <div class="input-group mb-4">
                    <label for="monthlyRentPerUnit" class="block text-sm mb-1">Monthly Rent Per Unit (in $)</label>
                    <input type="text" id="monthlyRentPerUnit" value="3,800" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="rentGrowthRate" class="block text-sm mb-1">Annual Rent Growth (%)</label>
                    <input type="number" id="rentGrowthRate" value="3.0" class="w-full" step="0.1" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="numUnits" class="block text-sm mb-1">Number of Rental Units (e.g., Duplex=2)</label>
                    <input type="number" id="numUnits" value="1" class="w-full" required min="1">
                </div>
                <div class="input-group mb-4">
                    <label for="vacancyRate" class="block text-sm mb-1">Vacancy Rate (%s)</label>
                    <input type="number" id="vacancyRate" value="5" class="w-full" step="0.1" required min="0" max="100">
                </div>
                <div class="input-group mb-4">
                    <label for="propertyTaxRate" class="block text-sm mb-1">Property Tax Rate (% of Value)</label>
                    <input type="number" id="propertyTaxRate" value="1.25" class="w-full" step="0.01" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="annualEarthquakePremium" class="block text-sm mb-1">Annual Earthquake Premium (in $)</label>
                    <input type="text" id="annualEarthquakePremium" value="3,500" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="otherInsurance" class="block text-sm mb-1">Property Insurance (Annual $)</label>
                    <input type="text" id="otherInsurance" value="3,000" class="w-full" onfocus="unformatInput(this)" onblur="formatInput(this); calculateInvestment()" required>
                </div>
                <div class="input-group mb-4">
                    <label for="mgmtFeeRate" class="block text-sm mb-1">Property Management Fee (% of Rent)</label>
                    <input type="number" id="mgmtFeeRate" value="6" class="w-full" step="0.1" required min="0" max="100">
                </div>
                <div class="input-group mb-4">
                    <label for="maintenanceReserveRate" class="block text-sm mb-1">Maintenance/Reserve (% of EGI)</label>
                    <input type="number" id="maintenanceReserveRate" value="10" class="w-full" step="0.1" required min="0" max="100">
                </div>
                
                <h3 class="font-bold mt-6 mb-2 text-accent-green">Tax & Market Settings</h3>
                <div class="input-group mb-4">
                    <label for="sp500Return" class="block text-sm mb-1">S&P 500 VOO Annual Return (%)</label>
                    <input type="number" id="sp500Return" value="10.0" class="w-full" step="0.1" required min="0">
                </div>
                <div class="input-group mb-4">
                    <label for="federalTaxRate" class="block text-sm mb-1">Federal Marginal Tax Rate (%)</label>
                    <input type="number" id="federalTaxRate" value="37" class="w-full" step="1" required min="0" max="100">
                </div>
                <div class="input-group mb-4">
                    <label for="stateTaxRate" class="block text-sm mb-1">State Marginal Tax Rate (%)</label>
                    <input type="number" id="stateTaxRate" value="10" class="w-full" step="1" required min="0" max="100">
                </div>
                <div class="input-group mb-4">
                    <label for="holdingPeriod" class="block text-sm mb-1">Investment Horizon (Years)</label>
                    <input type="number" id="holdingPeriod" value="15" class="w-full" required min="5" max="100">
                </div>

                <div class="input-group flex items-center justify-between mt-6 p-3 bg-gray-800 rounded-lg">
                    <label for="sellProperty" class="text-sm font-bold text-white">Sell Property at End of Horizon</label>
                    <input type="checkbox" id="sellProperty" class="toggle-switch" checked onchange="calculateInvestment()">
                </div>
                
                <div class="input-group flex items-center justify-between mt-4 p-3 bg-gray-800 rounded-lg">
                    <label for="adjustInflation" class="text-sm font-bold text-white">Adjust for Inflation (Real Return)</label>
                    <input type="checkbox" id="adjustInflation" class="toggle-switch" onchange="toggleInflationInput()">
                </div>
                <div class="input-group mb-4 mt-2" id="inflationRateInputContainer" style="display:none;">
                    <label for="inflationRate" class="block text-sm mb-1 text-gray-400">Annual Inflation Rate (%)</label>
                    <input type="number" id="inflationRate" value="3.0" class="w-full" step="0.1" required min="0" onchange="calculateInvestment()">
                </div>

            </div>

            <button onclick="calculateInvestment()" class="calculate-btn w-full text-white font-bold py-3 rounded-xl mt-6 shadow-md hover:shadow-lg">
                RUN COMPARISON
            </button>
            <!-- OPTIONAL ENHANCEMENT: Add Reset to Defaults Button -->
            <button onclick="resetToDefaults()" class="w-full text-gray-400 font-semibold py-2 rounded-xl mt-3 border border-gray-600 hover:bg-gray-800 hover:text-white transition-all">
                Reset to Defaults
            </button>
        </div>

        <!-- Output Panel --><div class="lg:col-span-2 card p-6 rounded-xl shadow-xl">
            <h2 class="text-xl font-semibold mb-6 card-header pl-3">Results Summary (Post-Tax)</h2>

            <!-- Summary Table --><div id="results-summary" class="mb-8">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <p class="font-semibold text-gray-300">Total Cash Invested (RE): <span id="totalCashInvested" class="font-bold text-accent-green">$0</span></p>
                    <p class="font-semibold text-gray-300">Loan Amount: <span id="loanAmount" class="font-bold text-accent-green">$0</span></p>
                    <p class="font-semibold text-gray-300">Annual Debt Service (P&I): <span id="annualDebtService" class="font-bold text-accent-green">$0</span></p>
                </div>
                
                <div class="mt-6">
                    <h3 class="font-semibold text-lg mb-2 text-gray-300">Post-Tax Compound Annual Growth Rate (<span id="cagr-type">Nominal</span>)</h3>
                    <div class="grid grid-cols-2 gap-4 text-center text-white font-bold">
                        <div class="bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700">
                            <div class="text-sm font-medium text-gray-400">Real Estate CAGR</div>
                            <div id="re-cagr" class="text-3xl mt-1 text-accent-green">N/A</div>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700">
                            <div class="text-sm font-medium text-gray-400">S&P 500 CAGR</div>
                            <div id="sp500-cagr" class="text-3xl mt-1 text-accent-blue">N/A</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8">
                    <h3 class="font-semibold text-lg text-gray-300 mb-4">Total Profit Comparison (Post-Tax)</h3>
                    <div id="re-bar" class="result-bar bg-green-500 mb-2" style="width: 0%;">
                        <span class="ml-2">Real Estate: $<span id="re-profit">0</span></span>
                    </div>
                    <div id="sp500-bar" class="result-bar bg-blue-500 mb-2" style="width: 0%;">
                        <span class="ml-2">S&P 500: $<span id="sp500-profit">0</span></span>
                    </div>
                </div>
                
            </div>

            <!-- Detailed Real Estate Metrics --><div id="re-details" class="mt-8 pt-4 border-t border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-accent-blue">Real Estate Financial Deep Dive (Total Investment Period)</h3>
                <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Total Equity Build (Principal Paydown):</p>
                        <p class="font-bold text-white" id="principal-paid">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Future Property Value (Appreciation):</p>
                        <p class="font-bold text-white" id="future-value">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Cumulative Post-Tax Cash Flow:</p>
                        <p class="font-bold text-white" id="cum-cash-flow">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Net Tax Savings (or Liability) from Operations:</p>
                        <p class="font-bold text-white" id="net-tax-impact">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Tax Due on Sale (Recapture + LTCG):</p>
                        <p class="font-bold text-white" id="tax-at-sale">$0</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                        <p class="font-medium">Year 1 Cash-on-Cash (CoC) Return:</p>
                        <p class="font-bold text-white" id="coc-return">0.00%</p>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-700 col-span-2">
                        <p class="font-medium">Avg. Annual Post-Payoff Cash Flow Yield (Post-Tax):</p>
                        <p class="font-bold text-white text-lg" id="post-payoff-yield">N/A</p>
                    </div>
                </div>
            </div>

            <!-- Calculation Proof and Table --><div id="calculation-proof-section" class="mt-8 pt-4 border-t border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-gray-300 card-header pl-3">
                    Detailed Calculation Proof (Total Investment Period)
                    <!-- FIX #4: Add Note About Nominal Values in Proof Table Header -->
                    <span class="text-xs font-normal text-gray-500 ml-2">(Intermediate values in nominal $)</span>
                </h3>
                <div id="proof-table-container">
                    <table class="proof-table w-full text-sm text-gray-300">
                        <thead class="font-semibold text-white bg-gray-800 border-b border-gray-600">
                            <tr>
                                <th class="py-3">Metric</th>
                                <th class="py-3 text-center border-l border-gray-700">Real Estate</th>
                                <th class="py-3 text-center">S&P 500 (VOO)</th>
                            </tr>
                        </thead>
                        <tbody id="proof-table-body">
                            <!-- Content inserted by JavaScript --></tbody>
                    </table>
                </div>

                <!-- NEW SECTION 1: Year 1 Performance Ratios & Efficiency -->
                <div class="mt-8 pt-4 border-t border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-accent-blue card-header pl-3">Year 1 Performance Ratios & Efficiency</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Net Operating Income (NOI):</p>
                            <p class="font-bold text-white" id="annual-noi">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Cap Rate (Unleveraged Return):</p>
                            <p class="font-bold text-white" id="annual-cap-rate">0.00%</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Cash Flow After Debt (Pre-Tax):</p>
                            <p class="font-bold text-white" id="annual-pre-tax-cf">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Cash-on-Cash Return (Leveraged):</p>
                            <p class="font-bold text-white" id="annual-coc-rate">0.00%</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Tax Savings / (Liability) from Operations:</p>
                            <p class="font-bold text-white" id="annual-tax-impact">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Monthly Cash Obligation (PITI + OpEx):</p>
                            <p class="font-bold text-white text-lg" id="monthly-obligation-new">$0</p>
                        </div>
                    </div>
                </div>
                <!-- End NEW SECTION 1 -->

                <!-- NEW SECTION 2: Cumulative Performance Snapshot (Year 5) -->
                <div class="mt-8 pt-4 border-t border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-accent-blue card-header pl-3">Cumulative Performance Snapshot (Year 5)</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Cumulative Post-Tax Cash Flow:</p>
                            <p class="font-bold text-white" id="y5-cum-cf">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Total Appreciation Gain (Pre-Tax):</p>
                            <p class="font-bold text-white" id="y5-appr-gain">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Total Equity Built (Principal Paydown):</p>
                            <p class="font-bold text-white" id="y5-principal-paid">$0</p>
                        </div>
                        <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                            <p class="font-medium">Post-Tax CAGR (Assuming Sale in Year 5):</p>
                            <p class="font-bold text-white" id="y5-cagr">0.00%</p>
                        </div>
                    </div>
                </div>
                <!-- End NEW SECTION 2 -->

                <!-- Executive Summary Box -->
                <div class="mt-8 summary-box rounded-xl">
                    <h3 class="text-xl font-bold mb-4 text-white border-b border-gray-700 pb-2">EXECUTIVE SUMMARY: Investment Comparison</h3>
                    <div id="executive-summary-content" class="text-sm text-gray-400">
                        <p>Loading summary...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- NEW SECTION: Glossary of Terms -->
    <div id="glossary-section" class="container mx-auto p-4 md:p-8 max-w-6xl mt-8">
        <h2 class="text-3xl font-bold mb-4 text-white card-header pl-3">Glossary of Terms</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
            
            <h3 class="col-span-2 font-bold text-white mt-2 mb-1 border-b border-gray-700 pb-1">Core Return Metrics</h3>

            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">CAGR (Compound Annual Growth Rate)</p>
                <p class="text-gray-400">The average annual rate of return over the investment horizon, assuming profits are reinvested. It is the single best metric for comparing different asset classes.</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Nominal Return vs. Real Return</p>
                <p class="text-gray-400">**Nominal** is the return in today's dollars. **Real** is the return adjusted for inflation, showing the actual gain in purchasing power.</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Cap Rate (Capitalization Rate)</p>
                <p class="text-gray-400">Measures the property's unleveraged profitability: Net Operating Income (NOI) $\div$ Property Value. It assumes an all-cash purchase (Year 1).</p>
            </div>

            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Cash-on-Cash (CoC) Return</p>
                <p class="text-gray-400">Measures the annual pre-tax cash flow relative to the total cash invested (down payment + closing costs). This is the key metric for leveraged cash flow (Year 1).</p>
            </div>
            
            <h3 class="col-span-2 font-bold text-white mt-4 mb-1 border-b border-gray-700 pb-1">Operational & Cash Flow Metrics</h3>

            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">EGI (Effective Gross Income)</p>
                <p class="text-gray-400">The property's total potential rental income minus losses from vacancy and non-payment.</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Net Operating Income (NOI)</p>
                <p class="text-gray-400">The property's annual income after deducting all operational expenses (taxes, insurance, maintenance, management) but **before** deducting debt service (P&I) or income taxes.</p>
            </div>

            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Cash Flow After Debt (Pre-Tax)</p>
                <p class="text-gray-400">The annual cash flow remaining after paying all operating expenses and the full mortgage payment (P&I), before income taxes (Year 1).</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Monthly Cash Obligation (PITI + OpEx)</p>
                <p class="text-gray-400">The total average monthly amount of money leaving your bank account for the property, including Principal, Interest, Property Taxes, Insurance, and Operating Expenses (Maintenance/Management).</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Cumulative Post-Tax Cash Flow</p>
                <p class="text-gray-400">The total sum of all rental cash flow received over the entire investment horizon, net of mortgage payments and adjusted for the annual tax impact of rental income/loss.</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Avg. Annual Post-Payoff Cash Flow Yield</p>
                <p class="text-gray-400">The annual post-tax cash flow earned *after* the mortgage is fully paid, expressed as a percentage return on the original initial cash investment.</p>
            </div>
            
            <h3 class="col-span-2 font-bold text-white mt-4 mb-1 border-b border-gray-700 pb-1">Total Wealth & Tax Metrics</h3>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Initial Cash Invested (Equity)</p>
                <p class="text-gray-400">The total cash outlay required for the investment, including the down payment and all closing costs (for both RE and VOO comparisons).</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Total Post-Tax Profit</p>
                <p class="text-gray-400">The final, spendable cash or retained wealth after all taxes, debt service, and costs have been accounted for. This is the figure used to calculate the final CAGR.</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Final Portfolio/Asset Value</p>
                <p class="text-gray-400">The calculated pre-tax market value of the asset (RE Future Value or VOO Portfolio Value) at the end of the holding period.</p>
            </div>

            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Future Property Value (Appreciation)</p>
                <p class="text-gray-400">The estimated market value of the real estate asset at the end of the holding period, calculated by compounding the initial price at the appreciation rate.</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Total Equity Build (Principal Paydown)</p>
                <p class="text-gray-400">The total non-taxable portion of your mortgage payments that reduced the loan balance and increased your ownership equity over the full horizon.</p>
            </div>

            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Total Appreciation Gain (Pre-Tax)</p>
                <p class="text-gray-400">The increase in the property's market value from the purchase price to the calculation date (Year 5 or end of horizon).</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Depreciation (Tax Shield)</p>
                <p class="text-gray-400">A non-cash deductible expense that reduces the property's taxable income, often creating a "phantom loss" that shelters rental cash flow from taxes.</p>
            </div>

            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Net Tax Savings / Liability (from Operations)</p>
                <p class="text-gray-400">The sum of all annual tax impacts (savings from depreciation/interest deductions, or liability from positive rental income) over the holding period. A negative number indicates total tax savings.</p>
            </div>
            
            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Total Tax Paid (All Sources)</p>
                <p class="text-gray-400">The sum of all taxes paid, including annual VOO dividend tax, operating tax impacts for RE, and the final tax due upon sale.</p>
            </div>

            <div class="p-4 bg-gray-900 rounded-lg">
                <p class="font-bold text-accent-green mb-1">Tax Due on Sale (Recapture + LTCG)</p>
                <p class="text-gray-400">The total liability incurred upon selling the asset, consisting of Depreciation Recapture Tax (25% rate) and Long-Term Capital Gains Tax (LTCG).</p>
            </div>

        </div>
    </div>
</div>

<script>
    // Constants for Federal Tax & General Assumptions (Used as BASE rates)
    const FEDERAL_LTCG_RATE = 0.20; // Federal Long-Term Capital Gains Rate
    const FEDERAL_RECAPTURE_RATE = 0.25; // Federal Depreciation Recapture Rate
    
    // Other General Constants
    const SELLING_COSTS_RATE = 0.06; // 6% selling costs
    const LOAN_TERM_MONTHS = 30 * 12; // 30-year loan
    const DEPRECIATION_TERM = 27.5; // Residential real estate depreciation term
    const LAND_VALUE_PERCENT = 0.20; // 20% of property value assumed to be non-depreciable land
    const DIVIDEND_YIELD = 0.015; // 1.5% dividend yield assumption for S&P 500

    // Helper function to remove formatting (for calculation)
    const unformatValue = (value) => {
        return parseFloat(String(value).replace(/[^0-9.]/g, ''));
    };

    // Helper function to format input display (for UI)
    const formatValueDisplay = (value) => {
        // Formats with commas and ensures no decimal if it's an integer
        if (value === null || isNaN(value)) return '';
        return Math.round(value).toLocaleString('en-US');
    };
    
    // UI handler to format the input on blur
    window.formatInput = function(element) {
        const value = unformatValue(element.value);
        element.value = formatValueDisplay(value);
    };

    // UI handler to remove formatting on focus
    window.unformatInput = function(element) {
        const value = unformatValue(element.value);
        element.value = isNaN(value) ? '' : value; // Display only the raw number
    };

    // Helper function for currency formatting (for output)
    const formatCurrency = (value) => {
        // Handles display of negative or zero values correctly
        if (value < 0) return `-$${Math.round(Math.abs(value)).toLocaleString()}`;
        return `$${Math.round(value).toLocaleString()}`;
    };
    
    // Helper function for percentage formatting
    const formatPercent = (value) => {
        return `${(value * 100).toFixed(2)}%`;
    };

    /**
     * Resets all input fields to their default values
     */
    function resetToDefaults() {
        document.getElementById('propertyValue').value = '1,500,000';
        document.getElementById('downPayment').value = '800,000';
        document.getElementById('closingCostsRate').value = '2';
        document.getElementById('mortgageRate').value = '5.75';
        document.getElementById('appreciationRate').value = '4.0';
        document.getElementById('monthlyRentPerUnit').value = '3,800';
        document.getElementById('rentGrowthRate').value = '3.0';
        document.getElementById('numUnits').value = '1';
        document.getElementById('vacancyRate').value = '5';
        document.getElementById('propertyTaxRate').value = '1.25';
        document.getElementById('annualEarthquakePremium').value = '3,500';
        document.getElementById('otherInsurance').value = '3,000';
        document.getElementById('mgmtFeeRate').value = '6';
        document.getElementById('maintenanceReserveRate').value = '10';
        document.getElementById('sp500Return').value = '10.0';
        document.getElementById('federalTaxRate').value = '37';
        document.getElementById('stateTaxRate').value = '10';
        document.getElementById('holdingPeriod').value = '15';
        document.getElementById('sellProperty').checked = true;
        document.getElementById('adjustInflation').checked = false;
        document.getElementById('inflationRate').value = '3.0';
        
        // Hide inflation input
        document.getElementById('inflationRateInputContainer').style.display = 'none';
        
        // Recalculate
        calculateInvestment();
    }
    window.resetToDefaults = resetToDefaults; // Expose to global scope

    /**
     * Generates the written summary based on the final calculated metrics.
     */
    function generateExecutiveSummary(re_cagr, sp500_cagr, re_profit, sp500_profit, appreciationRate, mortgageRate, sp500Return, holdingPeriod, sellProperty, inflationRate, adjustInflation) {
        let summary = ``;
        let superiorOption = "";
        let lesserOption = "";
        let cagrDifference = Math.abs(re_cagr - sp500_cagr) * 100;

        if (re_cagr > sp500_cagr) {
            superiorOption = "Real Estate (Leveraged)";
            lesserOption = "S&P 500 (VOO)";
        } else {
            superiorOption = "S&P 500 (VOO)";
            lesserOption = "Real Estate (Leveraged)";
        }

        const reProfitFormatted = formatCurrency(re_profit);
        const spProfitFormatted = formatCurrency(sp500_profit);
        const profitDifference = formatCurrency(Math.abs(re_profit - sp500_profit));
        
        const payoffYear = LOAN_TERM_MONTHS / 12;

        // --- Summary Content: Introduction ---
        
        summary += `<p class="mb-4 text-base text-white">This analysis compares two fundamentally different wealth-building strategies over a **${holdingPeriod}-year** horizon.</p>`;
        
        // FIX #3: Improve Inflation Status Visibility in Executive Summary (Fixed emoji)
        if (adjustInflation) {
            summary += `<div class="mb-4 p-3 bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg">
                <p class="text-yellow-300 font-semibold">ðŸ“Š INFLATION ADJUSTED RETURNS</p>
                <p class="text-yellow-200 text-sm mt-1">All CAGRs and profits shown are <strong>Real Returns</strong> adjusted for ${formatPercent(inflationRate)} annual inflation. These reflect actual purchasing power gains.</p>
            </div>`;
        } else {
            summary += `<div class="mb-4 p-3 bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg">
                <p class="text-blue-300 font-semibold">ðŸ“Š NOMINAL RETURNS</p>
                <p class="text-blue-200 text-sm mt-1">All CAGRs and profits shown are <strong>Nominal Returns</strong> (not adjusted for inflation). These are raw dollar gains without considering purchasing power changes.</p>
            </div>`;
        }

        // Results Table (Internal)
        summary += `<table class="w-full my-4 text-center text-white bg-gray-900 rounded-lg overflow-hidden">
            <thead>
                <tr class="bg-gray-800">
                    <th class="p-2">Investment</th>
                    <th class="p-2">Post-Tax CAGR</th>
                    <th class="p-2">Total Post-Tax Profit</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="p-2 text-accent-green">Real Estate</td>
                    <td class="p-2 text-accent-green">${formatPercent(re_cagr)}</td>
                    <td class="p-2 text-accent-green">${reProfitFormatted}</td>
                </tr>
                <tr>
                    <td class="p-2 text-accent-blue">S&P 500</td>
                    <td class="p-2 text-accent-blue">${formatPercent(sp500_cagr)}</td>
                    <td class="p-2 text-accent-blue">${spProfitFormatted}</td>
                </tr>
            </tbody>
        </table>`;

        summary += `<p class="mb-4 text-base text-white">Based on the calculated net returns, the **${superiorOption}** is the financially superior option, generating an additional **${profitDifference}** in final wealth. The primary difference lies in the mechanism of growth:</p>`;
        
        // --- Narrative Section 1: S&P 500 (Compounding Power) ---
        summary += `<h4 class="font-bold text-white mt-6 mb-2 text-lg border-b border-gray-700 pb-1">The S&P 500 VOO Path: Pure Compounding</h4>`;
        summary += `<p class="text-gray-400 mb-4">The S&P 500 strategy generates wealth through **unfettered, exponential compounding** at a high annual rate (${formatPercent(sp500Return)} nominal). The main cost is the annual tax drag on dividends and the large capital gains tax upon ${sellProperty ? 'sale' : 'deferral'}. Because this option avoids all operational friction (maintenance, management, earthquake insurance), its growth rate on the invested capital is difficult for any active, leveraged investment to beat unless appreciation is exceptional. It is a highly liquid and passive method.</p>`;

        // --- Narrative Section 2: Real Estate (Leverage and Tax Shield) ---
        summary += `<h4 class="font-bold text-white mt-6 mb-2 text-lg border-b border-gray-700 pb-1">The Real Estate Path: Leverage and Tax Shield</h4>`;
        summary += `<p class="text-gray-400 mb-4">Real estate is a multi-layered asset. Your initial $\$800,000$ down payment controls the growth of the entire $\$1.5\text{M}$ property value (**Leverage**). Its return is built on four pillars:</p>`;
        summary += `<ul class="list-disc list-inside ml-4 space-y-1 text-gray-400">`;
        summary += `<li>**Leveraged Appreciation:** Growth is based on the full property value, not just your equity.</li>`;
        summary += `<li>**Tax Shield:** Non-cash deductions (Depreciation and Interest) minimize your annual tax liability, often creating a "phantom loss" that shelters rental cash flow from taxes.</li>`;
        summary += `<li>**Principal Paydown:** A portion of the rent is forced savings, building equity tax-free.</li>`;
        if (holdingPeriod > payoffYear) {
             summary += `<li>**Post-Payoff Income:** After year ${payoffYear}, the investment converts into a robust, mortgage-free, growing income stream for the remaining **${holdingPeriod - payoffYear} years**.</li>`;
        }
        summary += `</ul>`;
        
        if (!sellProperty) {
            summary += `<p class="mt-4 text-yellow-300 font-medium">**Note on No-Sale Scenario:** When retaining the asset, the ${reProfitFormatted} profit represents the total *retained wealth* (equity + cash flow). This strategy prioritizes long-term income over a final cash liquidation.</p>`;
        }
        
        // --- Tipping Point (Dynamic Logic Implemented) ---
        summary += `<h4 class="font-bold text-white mt-6 mb-2 text-lg border-b border-gray-700 pb-1">Tipping Point Analysis: How the ${lesserOption} Could Win</h4>`;
        
        if (re_cagr < sp500_cagr) {
             // Scenario A: Real Estate Lost (Need RE to increase)
             summary += `<p class="text-gray-400">The Real Estate investment currently falls short because the **operational friction** (debt service, high property tax, and maintenance) is greater than the benefit derived from the ${formatPercent(appreciationRate)} appreciation rate. To reverse this outcome, you would need exceptional performance from real estate:</p>`;
             summary += `<ul class="list-disc list-inside ml-4 space-y-1 text-gray-400">`;
             summary += `<li>**Appreciation:** A significantly higher average appreciation rate (e.g., **6.5% - 7.0%**) is typically required to make the leveraged gain offset the stock market's compounding.</li>`;
             summary += `<li>**Financing:** A much lower mortgage rate (e.g., **below 4.0%**) dramatically reduces the largest annual drag on cash flow.</li>`;
             summary += `</ul>`;
        } else {
             // Scenario B: Real Estate Won (Need S&P to increase)
             summary += `<p class="text-gray-400">The Real Estate investment successfully won this comparison, primarily due to the power of **leverage and the tax shield** overcoming the high operational costs. To reverse this outcome, the S&P 500 would need to perform much better than assumed:</p>`;
             summary += `<ul class="list-disc list-inside ml-4 space-y-1 text-gray-400">`;
             summary += `<li>**Market Return:** The VOO annual return would need to be substantially higher (e.g., **12.0% - 13.0%** nominal) to generate compounding growth that outpaces the leveraged real estate gains.</li>`;
             summary += `<li>**Tax Efficiency:** Moving the VOO investment into a tax-advantaged retirement account (like a Roth IRA or 401k) would eliminate the annual tax drag on dividends, boosting its competitiveness significantly.</li>`;
             summary += `</ul>`;
        }


        document.getElementById('executive-summary-content').innerHTML = summary;
    }


    /**
     * Toggles the visibility of the inflation rate input field.
     */
    function toggleInflationInput() {
        const container = document.getElementById('inflationRateInputContainer');
        const checkbox = document.getElementById('adjustInflation');
        if (checkbox.checked) {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
        calculateInvestment(); // Recalculate when the toggle changes
    }
    window.toggleInflationInput = toggleInflationInput; // Expose to global scope for HTML event


    /**
     * The core financial calculation function.
     * Uses numerical approximations for financial functions (like PMT and interest/principal).
     */
    function calculateInvestment() {
        // --- 1. Get Inputs and Normalize (Using unformatValue for dollar fields) ---
        const propertyValue = unformatValue(document.getElementById('propertyValue').value);
        const downPayment = unformatValue(document.getElementById('downPayment').value);
        const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) / 100;
        const closingCostsRate = parseFloat(document.getElementById('closingCostsRate').value) / 100;
        const appreciationRate = parseFloat(document.getElementById('appreciationRate').value) / 100;
        const rentGrowthRate = parseFloat(document.getElementById('rentGrowthRate').value) / 100;
        const sp500Return = parseFloat(document.getElementById('sp500Return').value) / 100;
        const federalTaxRate = parseFloat(document.getElementById('federalTaxRate').value) / 100;
        const stateTaxRate = parseFloat(document.getElementById('stateTaxRate').value) / 100;
        const holdingPeriod = parseInt(document.getElementById('holdingPeriod').value);
        const monthlyRentPerUnit = unformatValue(document.getElementById('monthlyRentPerUnit').value);
        const numUnits = parseInt(document.getElementById('numUnits').value);
        const vacancyRate = parseFloat(document.getElementById('vacancyRate').value) / 100;
        const propertyTaxRate = parseFloat(document.getElementById('propertyTaxRate').value) / 100;
        const annualEarthquakePremium = unformatValue(document.getElementById('annualEarthquakePremium').value);
        const otherInsurance = unformatValue(document.getElementById('otherInsurance').value);
        const mgmtFeeRate = parseFloat(document.getElementById('mgmtFeeRate').value) / 100;
        const maintenanceReserveRate = parseFloat(document.getElementById('maintenanceReserveRate').value) / 100;
        const sellProperty = document.getElementById('sellProperty').checked; // NEW: Sell toggle
        
        // INFLATION VARIABLES
        const adjustInflation = document.getElementById('adjustInflation').checked;
        const inflationRate = adjustInflation ? (parseFloat(document.getElementById('inflationRate').value) / 100) : 0;


        // Input validation checks (simple console logs for this environment)
        if (isNaN(propertyValue) || propertyValue <= downPayment) { console.error("Property Value must be greater than the Down Payment."); return; }
        // Set max to 100 years
        if (holdingPeriod < 5 || holdingPeriod > 100) { console.error("Investment Horizon must be between 5 and 100 years."); return; }
        
        // --- 2. Calculate Total Tax Rates ---
        const totalMarginalRate = federalTaxRate + stateTaxRate; 
        const totalLTCGRate = FEDERAL_LTCG_RATE + stateTaxRate; 
        const totalRecaptureRate = FEDERAL_RECAPTURE_RATE + stateTaxRate; 

        // --- 3. Calculate Base Metrics ---
        const loanAmount = propertyValue - downPayment;
        const closingCosts = loanAmount * closingCostsRate;
        const totalCashInvested = downPayment + closingCosts;
        const totalInvestmentSP500 = downPayment; 
        
        // Depreciation must be defined early for Year 1 Tax Impact calculation
        const depreciableBasis = propertyValue * (1 - LAND_VALUE_PERCENT);
        const annualDepreciation = depreciableBasis / DEPRECIATION_TERM;


        // Mortgage Calculation
        const monthlyRate = mortgageRate / 12;
        const monthlyPayment = loanAmount * monthlyRate / (1 - Math.pow(1 + monthlyRate, -LOAN_TERM_MONTHS));
        const annualDebtService = monthlyPayment * 12;
        const payoffYear = LOAN_TERM_MONTHS / 12;

        // Amortization tracking arrays
        const annualInterest = [];
        const annualPrincipal = [];
        let balance = loanAmount;
        
        // Calculate principal and interest for the full 30-year term (or until balance hits zero)
        for (let y = 0; y < payoffYear; y++) {
            let totalAnnualInterest = 0;
            let totalAnnualPrincipal = 0;
            for (let m = 0; m < 12; m++) {
                if (balance <= 0) break; 
                
                const interest = balance * monthlyRate;
                const principal = monthlyPayment - interest;
                
                totalAnnualInterest += interest;
                totalAnnualPrincipal += principal;
                
                balance -= principal;
            }
            annualInterest.push(totalAnnualInterest);
            annualPrincipal.push(totalAnnualPrincipal);
        }
        
        // The arrays must be padded with 0s up to the holding period to prevent index errors in the main loop
        for (let y = payoffYear; y < holdingPeriod; y++) {
             annualInterest.push(0); // Padded with 0
             annualPrincipal.push(0); // Padded with 0
        }

        const remainingLoan = balance > 0 ? balance : 0;
        const principalPaid = annualPrincipal.reduce((sum, p) => sum + p, 0);


        // --- 4. Real Estate Post-Tax Calculation ---
        
        // Revenue & EGI & NOI (Year 1 only)
        const grossScheduledRent = monthlyRentPerUnit * numUnits * 12;
        const effectiveGrossIncome = grossScheduledRent * (1 - vacancyRate);
        const propertyTax = propertyValue * propertyTaxRate;
        const propertyMgmtFee = effectiveGrossIncome * mgmtFeeRate;
        const maintenanceReserve = effectiveGrossIncome * maintenanceReserveRate;
        const totalOpExYear1 = propertyTax + annualEarthquakePremium + otherInsurance + propertyMgmtFee + maintenanceReserve;
        let noiYear1 = effectiveGrossIncome - totalOpExYear1;

        // --- CALCULATIONS FOR ANNUAL BREAKDOWN (Year 1) ---
        // New Year 1 Efficiency Metrics
        const capRateYear1 = noiYear1 / propertyValue;
        const preTaxCashFlowYear1 = noiYear1 - annualDebtService;
        const cocReturnYear1 = preTaxCashFlowYear1 / totalCashInvested;
        
        const taxableIncomeLossYear1 = noiYear1 - (annualInterest[0] || 0) - annualDepreciation; // Depreciation must be defined early
        const taxImpactYear1 = taxableIncomeLossYear1 * totalMarginalRate; // Positive is liability, negative is savings
        
        const annualInterestYear1 = annualInterest[0] || 0; // Defensive check
        const annualPrincipalYear1 = annualPrincipal[0] || 0; // Defensive check
        const annualInsuranceTotal = annualEarthquakePremium + otherInsurance;
        const annualMaintenanceAndMgmt = propertyMgmtFee + maintenanceReserve;
        const totalMonthlyObligationDisplay = (annualDebtService + propertyTax + annualInsuranceTotal + annualMaintenanceAndMgmt) / 12;
        // --- END NEW CALCULATIONS ---


        // Depreciation
        const totalDepreciationRecaptured = annualDepreciation * holdingPeriod;
        
        // 15-Year Operational Cash Flow and Tax Calculation
        let postTaxCashFlow = 0;
        let preTaxCashFlow = 0; // New: for pre-tax profit calculation
        let totalTaxImpactOperations = 0;
        let currentNOI = noiYear1;
        
        let postPayoffCashFlowTotal = 0; // NEW: Track cash flow after payoff
        let postPayoffYears = 0; // NEW: Track years after payoff

        for (let year = 0; year < holdingPeriod; year++) {
            // Determine Annual Debt Service (ADS) for the current year
            let ads = (year < payoffYear) ? annualDebtService : 0;
            // DEFENSIVE CHECK HERE: Use array value or 0 if index is out of array bounds (shouldn't happen with padding)
            let currentAnnualInterest = annualInterest[year] || 0; 
            
            // Taxable Income Calculation
            // Depreciation continues for 27.5 years, regardless of mortgage status
            const taxDeductions = (year < DEPRECIATION_TERM) ? annualDepreciation : 0; // Stop depreciation after 27.5 years
            const taxableIncomeLoss = currentNOI - currentAnnualInterest - taxDeductions;
            const taxImpact = taxableIncomeLoss * totalMarginalRate;
            totalTaxImpactOperations += taxImpact; 

            // Cash Flow Calculation
            const cashFlowPreTax = currentNOI - ads;
            preTaxCashFlow += cashFlowPreTax; // Add to pre-tax total
            
            const cashFlowPostTax = cashFlowPreTax - taxImpact;
            postTaxCashFlow += cashFlowPostTax;
            
            // Track post-payoff cash flow
            if (year >= payoffYear) {
                postPayoffCashFlowTotal += cashFlowPostTax;
                postPayoffYears++;
            }
            
            // NOI grows by Rent Growth Rate
            currentNOI *= (1 + rentGrowthRate); 
        }

        // Calculate Post-Payoff Yield
        const postPayoffYield = (postPayoffYears > 0) ? (postPayoffCashFlowTotal / postPayoffYears) / totalCashInvested : 0;

        // Sale Calculations (Year H) - Conditional based on toggle
        let futurePropertyValue = propertyValue * Math.pow(1 + appreciationRate, holdingPeriod);
        let saleCosts = futurePropertyValue * SELLING_COSTS_RATE;
        let netSaleProceedesPreTax = futurePropertyValue - saleCosts - remainingLoan;

        let taxAtSale = 0;
        let finalEquityValue = futurePropertyValue - remainingLoan;
        
        if (sellProperty) {
            // Total Wealth REALIZED (Sale Model)
            const adjustedBasis = propertyValue - totalDepreciationRecaptured;
            const totalGain = futurePropertyValue - adjustedBasis;
            const gainRecaptured = totalDepreciationRecaptured; 
            const recaptureTax = gainRecaptured * totalRecaptureRate;
            const ltcgGain = totalGain - gainRecaptured;
            const ltcgTax = ltcgGain * totalLTCGRate;
            taxAtSale = recaptureTax + ltcgTax;
        } else {
            // Total Wealth RETAINED (No Sale Model)
            // Final Net Sale Proceeds is treated as the final equity value of the retained asset (no sale costs, no sale tax)
            netSaleProceedesPreTax = finalEquityValue; 
            saleCosts = 0;
            taxAtSale = 0;
        }
        
        // Final RE Profit Metrics (NOMINAL)
        const realEstateNetSale = netSaleProceedesPreTax - taxAtSale;
        const realEstateTotalPostTaxProfit_Nominal = realEstateNetSale + postTaxCashFlow - totalCashInvested;
        const realEstateCAGR_Nominal = Math.pow((totalCashInvested + realEstateTotalPostTaxProfit_Nominal) / totalCashInvested, 1 / holdingPeriod) - 1;
        
        // Apply Inflation Adjustment for Real Results
        // FIX #2: Correctly deflate nominal profit, don't recalculate profit from real CAGR
        const realEstateCAGR = (1 + realEstateCAGR_Nominal) / (1 + inflationRate) - 1;
        const realEstateTotalPostTaxProfit = adjustInflation ? (realEstateTotalPostTaxProfit_Nominal / Math.pow(1 + inflationRate, holdingPeriod)) : realEstateTotalPostTaxProfit_Nominal;

        // Pre-tax profit needs to also respect the "sell" toggle
        const realEstateTotalPreTaxProfit = preTaxCashFlow + (sellProperty ? (futurePropertyValue - saleCosts - remainingLoan) : finalEquityValue) - totalCashInvested;
        const realEstateTotalTaxPaid = totalTaxImpactOperations + taxAtSale;
        const cocReturn = (noiYear1 - annualDebtService) / totalCashInvested;
        
        // --- CALCULATE YEAR 5 CUMULATIVE METRICS ---
        const Y5_YEARS = 5;
        let currentNOI_Y5 = noiYear1;
        let cumPostTaxCashFlow_Y5 = 0;
        let cumPrincipalPaid_Y5 = 0;

        for (let y = 0; y < Y5_YEARS; y++) {
            let ads = (y < payoffYear) ? annualDebtService : 0;
            let currentAnnualInterest = annualInterest[y] || 0; 
            let currentAnnualPrincipal = annualPrincipal[y] || 0;
            const taxDeductions = (y < DEPRECIATION_TERM) ? annualDepreciation : 0;

            const taxableIncomeLoss = currentNOI_Y5 - currentAnnualInterest - taxDeductions;
            const taxImpact = taxableIncomeLoss * totalMarginalRate;
            
            const cashFlowPreTax = currentNOI_Y5 - ads;
            const cashFlowPostTax = cashFlowPreTax - taxImpact;
            
            cumPostTaxCashFlow_Y5 += cashFlowPostTax;
            cumPrincipalPaid_Y5 += currentAnnualPrincipal;

            currentNOI_Y5 *= (1 + rentGrowthRate);
        }

        const futurePropertyValue_Y5 = propertyValue * Math.pow(1 + appreciationRate, Y5_YEARS);
        const totalAppreciation_Y5 = futurePropertyValue_Y5 - propertyValue;
        const remainingLoan_Y5 = loanAmount - cumPrincipalPaid_Y5;
        const totalDepreciation_Y5 = annualDepreciation * Y5_YEARS; 
        
        // Post-Tax Profit & CAGR assuming sale at Year 5 (Standard Comparative Practice)
        const netSaleProceeds_Y5 = futurePropertyValue_Y5 * (1 - SELLING_COSTS_RATE) - remainingLoan_Y5;
        
        const adjustedBasis_Y5 = propertyValue - totalDepreciation_Y5;
        const totalGain_Y5 = futurePropertyValue_Y5 - adjustedBasis_Y5;
        const gainRecaptured_Y5 = totalDepreciation_Y5;
        const ltcgGain_Y5 = totalGain_Y5 - gainRecaptured_Y5;

        const recaptureTax_Y5 = gainRecaptured_Y5 * totalRecaptureRate;
        const ltcgTax_Y5 = ltcgGain_Y5 * totalLTCGRate;
        const taxAtSale_Y5 = recaptureTax_Y5 + ltcgTax_Y5;

        const totalPostTaxProfit_Y5_Nominal = netSaleProceeds_Y5 + cumPostTaxCashFlow_Y5 - totalCashInvested - taxAtSale_Y5;
        const cagr_Y5_Nominal = Math.pow((totalCashInvested + totalPostTaxProfit_Y5_Nominal) / totalCashInvested, 1 / Y5_YEARS) - 1;
        
        // Apply Inflation Adjustment for Year 5 Real Results
        // FIX #1: Year 5 CAGR Inflation Toggle
        const cagr_Y5 = adjustInflation ? ((1 + cagr_Y5_Nominal) / (1 + inflationRate) - 1) : cagr_Y5_Nominal;


        // --- 5. S&P 500 Post-Tax Calculation (VOO) ---
        
        const appreciation = sp500Return - DIVIDEND_YIELD;
        let sp500FV_pre_tax = totalInvestmentSP500; // Track pre-tax for pre-tax profit
        let sp500FV_post_tax = totalInvestmentSP500; // Track post-tax for post-tax profit
        let taxPaidOnDividends = 0;

        for (let year = 0; year < holdingPeriod; year++) {
            // FIX #1 (Previously Implemented): Correct S&P 500 Pre-Tax Future Value
            sp500FV_pre_tax = sp500FV_pre_tax * (1 + sp500Return); 

            // Dividends and Tax (Qualified Dividends assumed taxed at Total LTCG rate)
            const dividends = sp500FV_post_tax * DIVIDEND_YIELD; // Calculate dividend based on *Post-Tax* FV
            const dividendTax = dividends * totalLTCGRate;
            taxPaidOnDividends += dividendTax;
            
            // FV Update (Post-Tax)
            // Post-tax FV compounds only the appreciation, plus net dividends
            sp500FV_post_tax = sp500FV_post_tax * (1 + appreciation) + (dividends - dividendTax); 
        }

        // Final S&P 500 Profit Metrics - Conditional based on toggle
        let sp500TotalPostTaxProfit_Nominal = 0;
        let capitalGainsTax = 0;
        let sp500TotalTaxPaid = 0;
        
        // FIX #3 (Previously Implemented): Logic is verified to follow the correct sell/retain logic
        if (sellProperty) {
            // Total Wealth REALIZED (Sale Model)
            const totalGainSP500 = sp500FV_post_tax - totalInvestmentSP500;
            capitalGainsTax = totalGainSP500 * totalLTCGRate;
            sp500TotalTaxPaid = taxPaidOnDividends + capitalGainsTax; 
            sp500TotalPostTaxProfit_Nominal = sp500FV_post_tax - totalInvestmentSP500 - capitalGainsTax;
        } else {
            // Total Wealth RETAINED (No Sale Model)
            sp500TotalTaxPaid = taxPaidOnDividends; // Only annual dividend tax is paid
            sp500TotalPostTaxProfit_Nominal = sp500FV_post_tax - totalInvestmentSP500;
        }
        
        // Final VOO CAGR calculation remains the same (based on the derived post-tax profit)
        const sp500CAGR_Nominal = Math.pow((totalInvestmentSP500 + sp500TotalPostTaxProfit_Nominal) / totalInvestmentSP500, 1 / holdingPeriod) - 1;
        const sp500TotalPreTaxProfit = sp500FV_pre_tax - totalInvestmentSP500;
        
        // Apply Inflation Adjustment for Real Results
        // FIX #2 (Previously Implemented): Correctly deflate nominal profit, don't recalculate profit from real CAGR
        const sp500CAGR = (1 + sp500CAGR_Nominal) / (1 + inflationRate) - 1;
        const sp500TotalPostTaxProfit = adjustInflation ? (sp500TotalPostTaxProfit_Nominal / Math.pow(1 + inflationRate, holdingPeriod)) : sp500TotalPostTaxProfit_Nominal;


        // --- 6. Display Results ---
        
        // Update CAGR Title
        document.getElementById('cagr-type').textContent = adjustInflation ? 'Real' : 'Nominal';

        // Summary Block
        document.getElementById('totalCashInvested').textContent = formatCurrency(totalCashInvested);
        document.getElementById('loanAmount').textContent = formatCurrency(loanAmount);
        document.getElementById('annualDebtService').textContent = formatCurrency(annualDebtService);

        // CAGR & Profit Bars (Logic remains the same)
        document.getElementById('re-cagr').textContent = formatPercent(realEstateCAGR);
        document.getElementById('sp500-cagr').textContent = formatPercent(sp500CAGR);
        
        const reCagrElement = document.getElementById('re-cagr').closest('div');
        const spCagrElement = document.getElementById('sp500-cagr').closest('div');
        reCagrElement.className = 'bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700';
        spCagrElement.className = 'bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700';
        
        // Use custom accent classes for profit/loss visibility
        if (realEstateCAGR > sp500CAGR) { reCagrElement.classList.add('text-accent-green'); spCagrElement.classList.add('text-accent-blue'); } 
        else { spCagrElement.classList.add('text-accent-blue'); reCagrElement.classList.add('text-accent-green'); }

        document.getElementById('re-profit').textContent = formatCurrency(realEstateTotalPostTaxProfit).replace('$', '');
        document.getElementById('sp500-profit').textContent = formatCurrency(sp500TotalPostTaxProfit).replace('$', '');

        const maxProfit = Math.max(realEstateTotalPostTaxProfit, sp500TotalPostTaxProfit);
        const reWidth = (realEstateTotalPostTaxProfit / maxProfit) * 100;
        const spWidth = (sp500TotalPostTaxProfit / maxProfit) * 100;

        document.getElementById('re-bar').style.width = `${reWidth}%`;
        document.getElementById('sp500-bar').style.width = `${spWidth}%`;
        
        document.getElementById('re-bar').classList.remove('bg-green-500', 'bg-blue-500');
        document.getElementById('sp500-bar').classList.remove('bg-green-500', 'bg-blue-500');

        // Assign colors based on winner
        if (realEstateTotalPostTaxProfit > sp500TotalPostTaxProfit) {
            document.getElementById('re-bar').classList.add('bg-green-accent');
            document.getElementById('sp500-bar').classList.add('bg-blue-accent');
        } else {
            document.getElementById('re-bar').classList.add('bg-blue-accent');
            document.getElementById('sp500-bar').classList.add('bg-green-accent');
        }

        // Detailed Real Estate Metrics
        document.getElementById('principal-paid').textContent = formatCurrency(principalPaid);
        
        // Update Future Property Value display based on sell toggle
        let finalDisplayValue = propertyValue * Math.pow(1 + appreciationRate, holdingPeriod);
        if (sellProperty) {
             document.getElementById('future-value').textContent = formatCurrency(finalDisplayValue);
        } else {
            document.getElementById('future-value').textContent = `${formatCurrency(finalDisplayValue)} (Asset Retained)`;
        }

        document.getElementById('cum-cash-flow').textContent = formatCurrency(postTaxCashFlow);
        const cocReturnDisplay = isFinite(cocReturn) ? formatPercent(cocReturn) : 'N/A';
        document.getElementById('coc-return').textContent = cocReturnDisplay;
        
        const netTaxText = realEstateTotalTaxPaid < 0 ? `Savings: ${formatCurrency(Math.abs(realEstateTotalTaxPaid))}` : `Paid: ${formatCurrency(realEstateTotalTaxPaid)}`;
        document.getElementById('net-tax-impact').textContent = netTaxText;
        document.getElementById('tax-at-sale').textContent = formatCurrency(taxAtSale);
        if (!sellProperty) {
            document.getElementById('tax-at-sale').textContent += ' (Deferred)';
        }

        // NEW: Post-Payoff Yield Display
        const postPayoffYieldDisplay = (postPayoffYears > 0) ? formatPercent(postPayoffYield) : 'N/A (Mortgage Not Paid Off)';
        document.getElementById('post-payoff-yield').textContent = postPayoffYieldDisplay;
        
        if (holdingPeriod < payoffYear) {
            document.getElementById('post-payoff-yield').textContent = 'N/A (Horizon Too Short)';
        } else if (postPayoffYears === 0 && holdingPeriod >= payoffYear) {
             document.getElementById('post-payoff-yield').textContent = '0.00% (Cash Flow Years < 1)';
        }


        // --- 7. Generate Year 1 Performance Ratios & Efficiency ---
        document.getElementById('annual-noi').textContent = formatCurrency(noiYear1);
        document.getElementById('annual-cap-rate').textContent = formatPercent(capRateYear1);
        document.getElementById('annual-pre-tax-cf').textContent = formatCurrency(preTaxCashFlowYear1);
        document.getElementById('annual-coc-rate').textContent = formatPercent(cocReturnYear1);
        
        // FIX #5 (Previously Implemented): Consistent Tax Impact Sign
        const taxImpactYear1Text = taxImpactYear1 < 0 ? `Savings: ${formatCurrency(Math.abs(taxImpactYear1))}` : `Liability: ${formatCurrency(taxImpactYear1)}`;
        document.getElementById('annual-tax-impact').textContent = taxImpactYear1Text;
        
        document.getElementById('monthly-obligation-new').textContent = formatCurrency(totalMonthlyObligationDisplay);
        
        // --- 8. Generate Year 5 Cumulative Snapshot ---
        document.getElementById('y5-cum-cf').textContent = formatCurrency(cumPostTaxCashFlow_Y5);
        document.getElementById('y5-appr-gain').textContent = formatCurrency(totalAppreciation_Y5);
        document.getElementById('y5-principal-paid').textContent = formatCurrency(cumPrincipalPaid_Y5);
        document.getElementById('y5-cagr').textContent = formatPercent(cagr_Y5);
        
        
        // --- 9. Generate Proof Table ---
        const rows = [
            { label: "Initial Cash Invested (Equity)", re: totalCashInvested, sp: totalInvestmentSP500, bold: true },
            { label: "Final Portfolio/Asset Value", re: 'N/A', sp: sp500FV_pre_tax },
            // FIX #2: Reposition Proof Table Note
            { label: "Total Pre-Tax Profit", re: realEstateTotalPreTaxProfit, sp: sp500TotalPreTaxProfit, style: 'text-lg font-semibold bg-gray-900 text-yellow-300' },
            { label: "(Note: Intermediate values shown in nominal dollars)", re: "", sp: "", style: 'text-xs text-gray-500 italic' }, 
            { label: "---------------------------", re: "", sp: "" },
            { label: "RE: Principal Paydown (Equity Build)", re: principalPaid, sp: "N/A" },
            { label: "RE: Cumulative Pre-Tax Cash Flow", re: preTaxCashFlow, sp: "N/A" },
            { label: "S&P 500: Tax Paid on Dividends", re: "N/A", sp: taxPaidOnDividends },
            { label: "RE: Tax Impact on Operations (Savings)", re: totalTaxImpactOperations, sp: "N/A" },
            { label: "RE: Tax Paid on Sale (Recapture+LTCG)", re: taxAtSale, sp: "N/A" },
            { label: "S&P 500: Tax Paid on Final Sale", re: "N/A", sp: sellProperty ? capitalGainsTax : 0 }, // Corrected for accurate proof table display
            { label: "Total Tax Paid (15 Years)", re: realEstateTotalTaxPaid, sp: sp500TotalTaxPaid, style: 'font-semibold bg-gray-800 text-red-400' },
            { label: "---------------------------", re: "", sp: "" },
            { label: "Total Post-Tax Profit", re: realEstateTotalPostTaxProfit, sp: sp500TotalPostTaxProfit, style: 'text-xl font-bold bg-gray-900 text-accent-green' },
        ];

        let tableHtml = '';
        rows.forEach(row => {
            if (row.label.includes('---')) {
                tableHtml += `<tr><td colspan="3" class="p-1 bg-gray-800 border-b border-gray-700"></td></tr>`;
            } else {
                let reValue = (typeof row.re === 'number') ? formatCurrency(row.re) : row.re;
                let spValue = (typeof row.sp === 'number') ? formatCurrency(row.sp) : row.sp;
                
                // Special handling for the Final Portfolio/Asset Value row based on toggle
                if (row.label.includes("Final Portfolio/Asset Value")) {
                    if (sellProperty) {
                        reValue = formatCurrency(finalDisplayValue); // Use finalDisplayValue which has appreciated value
                    } else {
                        reValue = "N/A (Asset Retained)";
                    }
                }
                
                // Special handling for tax paid on sale (zero if not selling)
                if (row.label.includes("Tax Paid on Sale")) {
                     spValue = sellProperty ? formatCurrency(capitalGainsTax) : 'N/A (Deferred)';
                }


                // Add conditional formatting for Tax Paid/Savings
                // FIX #5 (Previously Implemented): Consistent Tax Impact Sign in Proof Table
                if (row.label.includes("Tax Impact on Operations")) {
                    reValue = row.re < 0 ? `Savings: ${formatCurrency(Math.abs(row.re))}` : `Liability: ${formatCurrency(row.re)}`;
                }
                if (row.label.includes("Total Tax Paid (15 Years)")) {
                    reValue = row.re < 0 ? `Savings: ${formatCurrency(Math.abs(row.re))}` : `Liability: ${formatCurrency(row.re)}`;
                }

                tableHtml += `
                    <tr class="${row.style || 'border-b border-gray-800'}">
                        <td class="${row.style ? 'font-bold' : ''}">${row.label}</td>
                        <td class="text-center ${row.style ? 'font-bold' : ''}">${reValue}</td>
                        <td class="text-center ${row.style ? 'font-bold' : ''}">${spValue}</td>
                    </tr>
                `;
            }
        });

        document.getElementById('proof-table-body').innerHTML = tableHtml;
        
        // --- 9. Generate and Display Executive Summary ---
        generateExecutiveSummary(realEstateCAGR, sp500CAGR, realEstateTotalPostTaxProfit, sp500TotalPostTaxProfit, appreciationRate, mortgageRate, sp500Return, holdingPeriod, sellProperty, inflationRate, adjustInflation);
    }
    
    // Run calculation on load with default values
    window.onload = function() {
        // Apply initial formatting to input fields
        document.getElementById('propertyValue').value = formatValueDisplay(unformatValue(document.getElementById('propertyValue').value));
        document.getElementById('downPayment').value = formatValueDisplay(unformatValue(document.getElementById('downPayment').value));
        document.getElementById('monthlyRentPerUnit').value = formatValueDisplay(unformatValue(document.getElementById('monthlyRentPerUnit').value));
        document.getElementById('annualEarthquakePremium').value = formatValueDisplay(unformatValue(document.getElementById('annualEarthquakePremium').value));
        document.getElementById('otherInsurance').value = formatValueDisplay(unformatValue(document.getElementById('otherInsurance').value));
        
        calculateInvestment();
    };

</script>

</body>
</html>

